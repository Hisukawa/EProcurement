import{u as ce,a as j,j as e}from"./app-2dY0mcfJ.js";import{u as me}from"./use-toast-DLLEHaaE.js";import Q from"./AutoCompleteInput-D7qdG5qU.js";import{D as ue,a as pe,b as xe,c as he,d as be,e as ge}from"./dialog-BOrtGsCV.js";import{B as W}from"./button-lZCF6GJV.js";import{F as fe}from"./file-text-ss69fOqK.js";import{M as je}from"./minus-BCxYWDox.js";import{S as ye}from"./send-horizontal-1Gp4Ai5E.js";import"./index-BT060lhp.js";import"./index-ptG2qq3X.js";import"./createLucideIcon-BSM3CWrD.js";import"./utils-C_hDN855.js";import"./index-t44Pv__V.js";function Te({purchaseOrder:m,inventoryItems:N=[],user:y,ppeOptions:w=[],icsNumber:b}){var D,R,q,O,F,T,$;const o=((R=(D=m==null?void 0:m.detail)==null?void 0:D.pr_detail)==null?void 0:R.purchase_request)??null,J=o?`${((q=o==null?void 0:o.focal_person)==null?void 0:q.firstname)??""} ${((O=o==null?void 0:o.focal_person)==null?void 0:O.middlename)??""} ${((F=o==null?void 0:o.focal_person)==null?void 0:F.lastname)??""}`.trim():"N/A",{data:n,setData:i,post:K,processing:C,errors:I}=ce({po_id:(m==null?void 0:m.id)??null,ics_number:b??"",requested_by:((T=o==null?void 0:o.focal_person)==null?void 0:T.id)??null,received_from:(y==null?void 0:y.id)??null,remarks:"",items:N.map(s=>{var t;return{inventory_item_id:s.id,recipient:"",recipient_division:"",estimated_useful_life:null,inventory_item_number:"",ppe_sub_major_account:"",general_ledger_account:"",office:"",school:"",quantity:s.total_stock>0?1:0,unit_cost:s.unit_cost??0,total_cost:s.unit_cost??0,series_number:"0001",description:s.item_desc??((t=s.product)==null?void 0:t.item_description)??"N/A",ppe:null,gl:null,officeObj:null,schoolObj:null}})}),[V,g]=j.useState(!1),{toast:S}=me(),[X,Z]=j.useState(""),[G,P]=j.useState("");j.useEffect(()=>{b&&!n.ics_number&&i("ics_number",b)},[b]);const k=(s,t,a)=>{const d=[...n.items];if(t==="quantity"){let c=parseFloat(a)||0;d[s].quantity=c,d[s].total_cost=c*(d[s].unit_cost??0)}else d[s][t]=a;i("items",d)},ee=s=>{i("items",n.items.filter((t,a)=>a!==s))},v=async()=>{const s=n.items.filter(t=>t.ppe&&t.gl&&t.quantity>0);if(s.length)try{const t=s[0],d=await(await fetch(`/api/ics-next-series?ppe=${encodeURIComponent(t.ppe.name.trim())}&gl=${encodeURIComponent(t.gl.name.trim())}`)).json();let c=parseInt(d.series||"0",10);const u=[...n.items];s.forEach(r=>{var E,z,B,U,L,H,M,Y;const h=c.toString().padStart(4,"0"),f=new Date().getFullYear().toString(),l=((E=r.ppe.code)==null?void 0:E.padStart(2,"0"))||"00",p=((z=r.gl.code)==null?void 0:z.padStart(2,"0"))||"00",_=((U=(B=r.officeObj)==null?void 0:B.code)==null?void 0:U.padStart(2,"0"))||"",A=((L=r.officeObj)==null?void 0:L.name)==="Schools"&&((H=r.schoolObj)!=null&&H.code)?r.schoolObj.code.padStart(2,"0"):"",re=[f,l,p,h,_].filter(Boolean).concat(A?[A]:[]).join("-"),ie=u.findIndex(de=>de===r);u[ie]={...r,inventory_item_number:re,series_number:h,ppe_sub_major_account:r.ppe.name,general_ledger_account:r.gl.name,office:((M=r.officeObj)==null?void 0:M.name)||"",school:((Y=r.schoolObj)==null?void 0:Y.name)||""},c++}),i("items",u)}catch(t){console.error("Error generating inventory numbers",t)}},se=(s,t)=>{const a=[...n.items];a[s].ppe=t,a[s].gl=null,a[s].ppe_sub_major_account=(t==null?void 0:t.name)||"",a[s].general_ledger_account="",i("items",a)},te=(s,t)=>{const a=[...n.items];a[s].gl=t,a[s].general_ledger_account=(t==null?void 0:t.name)||"",i("items",a),v(s,a[s])},ae=(s,t)=>{const a=[...n.items];a[s].officeObj=t,a[s].office=(t==null?void 0:t.name)||"",i("items",a),v(s,a[s])},le=(s,t)=>{const a=[...n.items];a[s].schoolObj=t,a[s].school=(t==null?void 0:t.name)||"",i("items",a),v(s,a[s])},oe=s=>{s.preventDefault(),g(!0)},ne=()=>{K(route("supply_officer.store_ics"),{preserveScroll:!0,onSuccess:()=>{g(!1),S({title:"ICS Recorded",description:"Inventory Custodian Slip successfully saved!",className:"bg-green-600 text-white",duration:3e3})},onError:()=>{S({title:"Save Failed",description:"Please review inputs and try again.",variant:"destructive",duration:4e3})}})},x=N.some(s=>s.source_type==="central");return e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[e.jsxs("h2",{className:"text-3xl font-bold text-blue-800 mb-4 flex items-center gap-2",children:[e.jsx(fe,{size:24})," Inventory Custodian Slip (ICS)"]}),Object.keys(I).length>0&&e.jsx("div",{className:"bg-red-100 text-red-700 p-4 rounded mb-4",children:e.jsx("ul",{className:"list-disc list-inside",children:Object.entries(I).map(([s,t])=>e.jsx("li",{children:t},s))})}),e.jsxs("form",{onSubmit:oe,className:"space-y-6",children:[e.jsxs("div",{className:"p-5 border rounded-md bg-blue-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mb-4",children:"ICS Info"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Designation"}),e.jsx("input",{value:(($=o==null?void 0:o.division)==null?void 0:$.division)??"N/A",readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"ICS No."}),e.jsx("input",{type:"text",value:n.ics_number,onChange:s=>i("ics_number",s.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Requested By"}),e.jsx("input",{value:J,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]})]})]}),n.items.map((s,t)=>{var a,d,c,u,r,h,f;return e.jsxs("div",{className:"p-5 border rounded-md bg-green-50 relative",children:[n.items.length>1&&e.jsx("button",{type:"button",onClick:()=>ee(t),className:"absolute top-2 right-2 text-red-600 hover:text-red-800",children:e.jsx(je,{size:20})}),e.jsxs("h3",{className:"text-lg font-semibold text-green-700 mb-4",children:["Item ",t+1]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Description"}),e.jsx("input",{value:s.description,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"PPE Sub-major Account"}),e.jsxs("select",{value:((a=s.ppe)==null?void 0:a.id)||"",onChange:l=>se(t,w.find(p=>p.id==l.target.value)),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",children:[e.jsx("option",{value:"",children:"Select PPE"}),w.map(l=>e.jsx("option",{value:l.id,children:l.code?`${l.code} - ${l.name}`:l.name},l.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"General Ledger Account"}),e.jsxs("select",{value:((d=s.gl)==null?void 0:d.id)||"",onChange:l=>{var p;return te(t,(p=s.ppe)==null?void 0:p.general_ledger_accounts.find(_=>_.id==l.target.value))},disabled:!s.ppe,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select GL"}),(u=(c=s.ppe)==null?void 0:c.general_ledger_accounts)==null?void 0:u.map(l=>e.jsx("option",{value:l.id,children:l.code?`${l.code} - ${l.name}`:l.name},l.id))]})]}),e.jsx(Q,{label:"Location Office",apiRoute:"/api/office-search",value:((r=s.officeObj)==null?void 0:r.code)||"",onChange:l=>ae(t,l),placeholder:"Type Location Office..."}),((h=s.officeObj)==null?void 0:h.name)==="Schools"&&e.jsx(Q,{label:"School",apiRoute:"/api/school-search",value:((f=s.schoolObj)==null?void 0:f.name)||"",onChange:l=>le(t,l),placeholder:"Type School..."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Inventory Item No."}),e.jsx("input",{value:s.inventory_item_number||"",readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-100"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Quantity"}),e.jsx("input",{type:"number",min:"1",max:s.total_stock,value:s.quantity,onChange:l=>k(t,"quantity",l.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Unit Cost"}),e.jsx("input",{type:"number",value:s.unit_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Total Cost"}),e.jsx("input",{type:"number",value:s.total_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Estimated Useful Life (years)"}),e.jsx("input",{type:"number",value:s.estimated_useful_life??"",onChange:l=>k(t,"estimated_useful_life",l.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",onWheel:l=>l.currentTarget.blur(),required:!0})]})]},t)}),e.jsxs("div",{className:"p-5 border rounded-md bg-yellow-50",children:[e.jsxs("h3",{className:"text-lg font-semibold text-yellow-700 mb-4",children:["Default Recipient (applied to all items)",x&&e.jsx("span",{className:"text-red-600 ml-2 text-sm font-normal",children:"* Required for CENTRAL sourced items"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Recipient Name ",x&&e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"text",value:X,onChange:s=>{Z(s.target.value),i("items",n.items.map(t=>({...t,recipient:s.target.value})))},placeholder:"Leave blank to issue to requester",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",required:x})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Recipient Division ",x&&e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"text",value:G,onChange:s=>{P(s.target.value),i("items",n.items.map(t=>({...t,recipient_division:s.target.value})))},placeholder:"Optional",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",required:x})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remarks"}),e.jsx("textarea",{value:n.remarks,onChange:s=>i("remarks",s.target.value),rows:"4",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",placeholder:"Optional"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"submit",className:"inline-flex items-center px-6 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800",disabled:C,children:[e.jsx(ye,{size:16,className:"mr-2"})," ",C?"Saving...":"Submit Issuance"]})})]}),e.jsx(ue,{open:V,onOpenChange:g,children:e.jsxs(pe,{className:"sm:max-w-md",children:[e.jsxs(xe,{children:[e.jsx(he,{children:"Confirm Issuance"}),e.jsx(be,{children:"Are you sure you want to record this ICS issuance?"})]}),e.jsxs(ge,{className:"mt-4 flex justify-end gap-2",children:[e.jsx(W,{variant:"secondary",onClick:()=>g(!1),children:"Cancel"}),e.jsx(W,{onClick:ne,children:"Yes, Record ICS"})]})]})})]})}export{Te as default};
