import{a,u as K,j as e,H as xe,c as w}from"./app-DqNKJLgr.js";import{A as be}from"./ApproverLayout-DwOQ6ePS.js";import{D as C,a as R,b as I,c as O,d as A,e as D}from"./dialog-K3Udw0HJ.js";import{B as d}from"./button-CskkiS1y.js";import{T as Q}from"./textarea-CVvkKram.js";import{u as he}from"./use-toast-CL8hAUqx.js";import{A as fe}from"./AOQTabs-CuC8_Qc4.js";import{L as U}from"./label-BbkegtU2.js";import{I as X}from"./input-D5JLXii0.js";import"./Dropdown-CjzGQG1v.js";import"./transition-VnkB6yEf.js";import"./toaster-B2M20uYh.js";import"./index-DiY8fTyq.js";import"./index-4KP02Cg3.js";import"./createLucideIcon-4VTRvRLE.js";import"./utils-CV84Dt2y.js";import"./index-BQJYIOB-.js";import"./index-C4jjeOAD.js";import"./XMarkIcon-DYHW1NvJ.js";import"./file-text-DPSMfJ5_.js";import"./BellAlertIcon-C8rm6HJI.js";import"./index-Dl_JvOZ6.js";function Me({rfq:o,groupedDetails:u={},committee:x}){var J;const b=o.purchase_request,[W,Z]=a.useState(""),[j,f]=a.useState({open:!1,type:"success",title:"",description:""}),[q,y]=a.useState(!1),{toast:v}=he(),[m,ee]=a.useState(null),[_,$]=a.useState(""),[g,se]=a.useState(o.award_mode??"whole-pr"),[E,te]=a.useState(()=>{const s={};return["secretariat","member1","member2","member3","vice_chair","chair"].forEach(r=>{var c,i;const n=(i=(c=x==null?void 0:x.members)==null?void 0:c.filter(l=>l.position===r))==null?void 0:i.find(l=>l.status==="active");s[r]={name:(n==null?void 0:n.name)||"",status:(n==null?void 0:n.status)||"inactive"}}),{status:(x==null?void 0:x.status)||"draft",members:s}}),[re,F]=a.useState(!1),[z,ge]=a.useState(null),[M,P]=a.useState(!1),[H,T]=a.useState(!1),[je,ye]=a.useState("as-read"),ae=()=>{T(!0);const s={remarks_as_read:W,mode:g,...g==="per-item"?{detail_id:z.detailId}:{}};w.post(route("bac_user.rollback_winner_as_read",{id:z.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{F(!1),T(!1),f({open:!0,type:"success",title:"Rollback Successful",description:"Winner selection has been rolled back."}),v({title:"Rollback Successful",description:"Winner selection has been rolled back.",duration:3e3})},onError:()=>{T(!1),f({open:!0,type:"error",title:"Rollback Failed",description:"Unable to rollback winner. Please try again."})}})},h={};b.details.forEach(s=>{(u[s.id]||[]).forEach(r=>{const n=r.supplier.id;h[n]||(h[n]={supplier:r.supplier,detailIds:new Set,total:0,quotes:[]}),h[n].detailIds.add(s.id);const c=s.quantity??1,i=parseFloat(r.quoted_price??0)||0;h[n].total+=i*c,h[n].quotes.push(r),r.is_winner_as_read})});const ne=b.details.length,B=Object.values(h).filter(s=>s.detailIds.size===ne).length>0;a.useEffect(()=>{!B&&g==="whole-pr"&&se("per-item")},[B,g]),b.details.some(s=>(u[s.id]||[]).some(t=>t.is_winner_as_calculated));const[le,N]=a.useState(!1),[k,ie]=a.useState(null),[G,V]=a.useState(""),[Y,L]=a.useState(!1),oe=()=>{L(!0);const s={supplier_id:k.supplierId,remarks_as_read:G,mode:g,...k.detailId!==null?{detail_id:k.detailId}:{}};w.post(route("bac_user.save_remarks_as_read",{id:k.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{L(!1),N(!1),v({title:"Remarks Saved",description:"Supplier remarks updated successfully.",duration:3e3}),w.reload({only:["rfq","groupedDetails"]})},onError:()=>{L(!1),v({title:"Save Failed",description:"Could not save remarks. Please try again.",variant:"destructive",duration:3e3})}})};K({project_no:"",date_of_opening:"",venue:""});const p=K({project_no:o.project_no||"",date_of_opening:o.date_of_opening||"",venue:o.venue||""});a.useEffect(()=>{p.setData({project_no:o.project_no||"",date_of_opening:o.date_of_opening||"",venue:o.venue||""})},[o]);const ce=s=>{s.preventDefault(),p.post(route("bac_user.submit_project_info",o.id))},de=s=>window.open(route("bac_user.print_aoq_per_item_grouped_read",{id:s}),"_blank");return e.jsxs(be,{children:[e.jsx(xe,{title:`Abstract for ${b.pr_number}`}),e.jsxs("div",{className:"px-8 py-10",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-6",children:["Abstract of Quotations â€“ PR #",b.pr_number]}),e.jsx(fe,{pr:b.id}),e.jsx("div",{className:"mb-4 flex justify-between items-center",children:e.jsx("button",{onClick:()=>window.history.back(),className:"inline-flex items-center px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-md text-sm shadow-sm",children:"â† Back"})}),!B&&e.jsx("p",{className:"text-sm text-red-600 mb-4",children:"âš ï¸ No supplier quoted for all items. You can only declare winners per item."}),e.jsx("form",{onSubmit:ce,className:"mt-6 mb-4 border-t pt-6",children:e.jsxs("div",{className:"bg-white shadow-md rounded-lg p-6 space-y-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-3",children:"Project Information"}),e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 text-white",onClick:()=>de(o.id),children:"ðŸ–¨ï¸ Print AOQ AS READ"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(U,{htmlFor:"project_number",className:"text-sm font-medium text-gray-700 mb-1",children:"Project Number"}),e.jsx(Q,{id:"project_number",rows:6,className:"resize-none bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:p.data.project_no,onChange:s=>p.setData("project_no",s.target.value),placeholder:"Enter project number..."})]}),e.jsxs("div",{className:"flex flex-col justify-between h-full space-y-4",children:[e.jsxs("div",{children:[e.jsx(U,{htmlFor:"date_opening",className:"text-sm font-medium text-gray-700 mb-1",children:"Date of Opening"}),e.jsx(X,{id:"date_opening",type:"date",className:"w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:p.data.date_of_opening,onChange:s=>p.setData("date_of_opening",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(U,{htmlFor:"venue",className:"text-sm font-medium text-gray-700 mb-1",children:"Venue"}),e.jsx(X,{id:"venue",type:"text",className:"w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:p.data.venue,onChange:s=>p.setData("venue",s.target.value),placeholder:"Enter venue..."})]})]})]}),e.jsx("div",{className:"pt-4 border-t mt-6 flex justify-end",children:e.jsx(d,{type:"submit",disabled:p.processing,className:"px-6",children:p.processing?"Submitting...":"Submit Project Info"})})]})}),e.jsxs("div",{className:"border rounded-lg bg-white shadow-sm p-4 mt-8 mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-800",children:"Abstract of Quotation"}),e.jsxs("table",{className:"w-full text-sm border border-gray-300 rounded-lg overflow-hidden",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-4 py-3 text-left font-semibold w-64",children:"Item Description"}),Array.from(new Map(Object.values(u).flat().map(s=>[s.supplier.id,s.supplier])).values()).map(s=>e.jsx("th",{className:"border px-4 py-3 text-center font-semibold",children:s.company_name},s.id))]})}),e.jsxs("tbody",{children:[b.details.map((s,t)=>{const r=u[s.id]||[],n=Array.from(new Map(Object.values(u).flat().map(i=>[i.supplier.id,i.supplier])).values()),c=r.reduce((i,l)=>{const S=parseFloat(l.quoted_price)||0;return!i||S<parseFloat(i.quoted_price)?l:i},null);return e.jsxs("tr",{className:`${t%2===0?"bg-white":"bg-gray-50"}`,children:[e.jsxs("td",{className:"border px-4 py-3",children:[e.jsxs("div",{className:"font-semibold text-gray-800",children:[s.item," ",s.specs]}),e.jsxs("div",{className:"text-xs text-red-500",children:["Qty: ",s.quantity," ",s.unit]})]}),n.map(i=>{const l=r.find(ue=>ue.supplier.id===i.id),S=l==null?void 0:l.is_winner_as_read,me=c&&(l==null?void 0:l.supplier.id)===c.supplier.id;if(!l)return e.jsx("td",{className:"border text-center text-gray-400 italic py-3",children:"â€”"},i.id);const pe=(parseFloat(l.quoted_price)||0)*(parseFloat(s.quantity)||0);return e.jsxs("td",{className:`border px-4 py-2 text-center ${me?"bg-green-50 font-semibold text-green-700":""} ${S?"border-2 border-green-400":""}`,children:[e.jsxs("div",{children:["â‚±",parseFloat(l.quoted_price).toLocaleString()]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["â‚±",pe.toLocaleString()]}),S&&e.jsx("div",{className:"text-xs text-green-700 font-semibold",children:"âœ… Winner"})]},i.id)})]},s.id)}),e.jsxs("tr",{className:"bg-blue-50 font-semibold text-gray-800",children:[e.jsx("td",{className:"border px-4 py-2 text-right",children:"Total:"}),Array.from(new Map(Object.values(u).flat().map(s=>[s.supplier.id,s.supplier])).values()).map(s=>{var r;const t=((r=h[s.id])==null?void 0:r.total)||0;return e.jsxs("td",{className:"border px-4 py-2 text-center text-blue-700",children:["â‚±",t.toLocaleString()]},s.id)})]}),e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-2 text-right font-medium text-gray-700",children:"Remarks:"}),Array.from(new Map(Object.values(u).flat().map(s=>[s.supplier.id,s.supplier])).values()).map(s=>{const t=Object.values(u).flat().filter(c=>c.supplier.id===s.id).map(c=>c.remarks_as_read).filter(Boolean),r=[...new Set(t)],n=r.length>0?r.join("; "):"No remarks";return e.jsx("td",{className:"border px-4 py-2 text-center text-gray-600",children:r.length>0?n:e.jsx("span",{className:"italic text-gray-400",children:"No remarks"})},s.id)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"border px-4 py-2 text-right font-medium text-gray-700",children:"Actions:"}),Array.from(new Map(Object.values(u).flat().map(s=>[s.supplier.id,s.supplier])).values()).map(s=>e.jsx("td",{className:"border px-4 py-3 text-center",children:e.jsx(d,{type:"button",size:"xs",variant:"outline",onClick:()=>{ie({rfqId:o.id,supplierId:s.id,detailId:null,currentRemarks:""}),V(""),N(!0)},children:"Edit Remarks"})},s.id))]})]})]})]}),e.jsxs("div",{className:"mb-8 p-4 border rounded-lg bg-gray-50 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"BAC Committee"}),e.jsx("ul",{className:"space-y-3",children:["chair","vice_chair","secretariat","member1","member2","member3"].map(s=>{const t=E.members[s];return(t==null?void 0:t.status)==="active"&&e.jsxs("li",{className:"flex items-center justify-between bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.name||"â€”"}),e.jsx("p",{className:"text-sm text-gray-500",children:s.replace("_"," ").toUpperCase()})]}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{ee({position:s,current:t}),$(""),y(!0)},children:"Replace"})]},s)})})]})]}),e.jsx(C,{open:q,onOpenChange:y,children:e.jsxs(R,{className:"sm:max-w-md",children:[e.jsxs(I,{children:[e.jsx(O,{children:"Replace Committee Member"}),e.jsxs(A,{children:["Enter a new member to replace"," ",e.jsx("strong",{children:((J=m==null?void 0:m.current)==null?void 0:J.name)||"N/A"})," (",m==null?void 0:m.position.replace("_"," ").toUpperCase(),")."]})]}),e.jsx("input",{type:"text",value:_,onChange:s=>$(s.target.value),placeholder:"Enter new member name",className:"w-full border px-3 py-2 rounded mb-2"}),e.jsxs(D,{className:"mt-4",children:[e.jsx(d,{variant:"secondary",onClick:()=>y(!1),children:"Cancel"}),e.jsx(d,{disabled:M,onClick:()=>{if(!_.trim())return;P(!0),te(t=>({...t,members:{...t.members,[m.position]:{name:_.trim(),status:"active"}}}));const s={id:(x==null?void 0:x.id)??null,status:E.status,members:Object.entries({...E.members,[m.position]:{name:_.trim(),status:"active"}}).map(([t,r])=>({position:t,name:r.name,status:r.status}))};w.post(route("bac.committee.save"),s,{preserveScroll:!0,onSuccess:()=>{P(!1),y(!1),f({open:!0,type:"success",title:"Committee Updated",description:`${m.position.replace("_"," ")} replaced successfully.`}),v({title:"Committee Updated",description:`${m.position.replace("_"," ")} replaced successfully.`,duration:3e3})},onError:()=>{P(!1),f({open:!0,type:"error",title:"Committee Update Failed",description:"Unable to replace committee member. Please try again."})}})},children:M?"Saving...":"Confirm"})]})]})}),e.jsx(C,{open:re,onOpenChange:F,children:e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Rollback Winner"}),e.jsx(A,{children:"Provide remarks for rolling back this winner selection."})]}),e.jsx(Q,{value:W,onChange:s=>Z(s.target.value)}),e.jsxs(D,{children:[e.jsx(d,{variant:"secondary",onClick:()=>F(!1),children:"Cancel"}),e.jsx(d,{disabled:H,variant:"destructive",onClick:ae,children:H?"Rolling Back Winner...":"Confirm Rollback"})]})]})}),e.jsx(C,{open:j.open,onOpenChange:s=>f(t=>({...t,open:s})),children:e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{className:j.type==="error"?"text-red-600":"text-green-600",children:j.title}),e.jsx(A,{children:j.description})]}),e.jsx(D,{children:e.jsx(d,{onClick:()=>f(s=>({...s,open:!1})),children:"Close"})})]})}),e.jsx(C,{open:le,onOpenChange:N,children:e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Edit Supplier Remarks"}),e.jsxs(A,{children:["Enter remarks for this supplier ",g==="per-item"?"on this item":"for the PR","."]})]}),e.jsx(Q,{value:G,onChange:s=>V(s.target.value)}),e.jsxs(D,{children:[e.jsx(d,{variant:"secondary",onClick:()=>N(!1),children:"Cancel"}),e.jsx(d,{disabled:Y,onClick:oe,children:Y?"Saving...":"Save"})]})]})})]})}export{Me as default};
