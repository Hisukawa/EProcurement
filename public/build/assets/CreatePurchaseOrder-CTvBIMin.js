import{r as l,u as $,j as e,H}from"./app-zVUDkyzP.js";import{S as M}from"./SupplyOfficerLayout-FhXVWMQH.js";import{D as C,a as D,b as v,c as P,d as O,e as I}from"./dialog-UUM-sVls.js";import{B as o}from"./button-BAV8ucVR.js";import{T as B}from"./triangle-alert-id5tr1hE.js";import"./toaster-D8SHsd9C.js";import"./use-toast-SfBWm5Kp.js";import"./index-B_sYnd9c.js";import"./index-DtDLCPOc.js";import"./createLucideIcon-B0te037c.js";import"./index-Dzx9dIXH.js";import"./index-CG4CbV8-.js";import"./Dropdown-zT0pG-PO.js";import"./transition-DqO-TKob.js";import"./XMarkIcon-CiGnVPuc.js";import"./clipboard-check-DUrY4GM2.js";import"./index-CDbMdTPK.js";function le({pr:h,rfq:q,suppliers:N,winners:c}){const _=l.useMemo(()=>[...new Set(c.map(r=>r.supplier_id))],[c]),g=l.useMemo(()=>N.filter(r=>_.includes(r.id)),[N,_]),[F,d]=l.useState(!1),[S,b]=l.useState(null),[f,y]=l.useState(""),[R,m]=l.useState(!1),T=r=>c.filter(t=>t.supplier_id===r).map(t=>{const i=Number(t.unit_price_edited??t.unit_price??t.quoted_price??0),a=t.mode==="as-calculated"&&t.total_price_calculated!=null?Number(t.total_price_calculated):i*Number(t.quantity??0);return{pr_detail_id:t.pr_detail_id,item:t.item,specs:t.specs,unit:t.unit,quantity:t.quantity,unit_price:i,total_price:a,priceSource:t.unit_price_edited?"Edited Price":t.mode==="as-calculated"?"Calculated Total":"Quoted Price"}}),{data:u,setData:j,post:U,processing:p}=$({rfq_id:q.id,items:[]});l.useEffect(()=>{const r=g.flatMap(s=>T(s.id).map(t=>({...t,supplier_id:s.id})));j("items",r)},[g]);const E=(r,s,t)=>{var x;const i=[...u.items],a=Number(t)>=0?Number(t):0,n=(x=h.details.find(A=>A.id===i[r].pr_detail_id))==null?void 0:x.quantity;if(a!==n){b({index:r,field:s,value:a}),d(!0);return}i[r][s]=a,i[r].total_price=a*Number(i[r].unit_price),j("items",i)},L=()=>{if(!S)return;const{index:r,field:s,value:t}=S,i=[...u.items];i[r][s]=t,i[r].total_price=Number(i[r].quantity)*Number(i[r].unit_price),i[r].change_reason=f,j("items",i),b(null),y(""),d(!1)},Q=r=>{r.preventDefault(),m(!0)},k=()=>{U(route("supply_officer.store_po"),{onFinish:()=>m(!1)})};return e.jsxs(M,{header:"Schools Divisions Office - Ilagan | Create Purchase Order",children:[e.jsx(H,{title:`Create PO for PR #${h.pr_number}`}),e.jsxs("form",{onSubmit:Q,className:"bg-white p-6 rounded shadow mx-auto max-w-6xl",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-6",children:["Create PO for PR #",h.pr_number]}),g.map(r=>{const s=u.items.filter(t=>t.supplier_id===r.id);return s.reduce((t,i)=>t+Number(i.total_price),0),e.jsxs("div",{className:"mb-8 border rounded-lg shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-3 font-semibold text-lg",children:["Supplier: ",r.company_name]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto border-separate border-spacing-0 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-y border-l px-4 py-2 text-left",children:"Item"}),e.jsx("th",{className:"border-y px-4 py-2 text-left",children:"Specs"}),e.jsx("th",{className:"border-y px-4 py-2 text-center",children:"Unit"}),e.jsx("th",{className:"border-y px-4 py-2 text-right text-blue-600",children:"Quantity"}),e.jsx("th",{className:"border-y px-4 py-2 text-right",children:"Unit Price"}),e.jsx("th",{className:"border-y px-4 py-2 text-right",children:"Total Price"})]})}),e.jsxs("tbody",{children:[s.map((t,i)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border-b border-l px-4 py-2",children:t.item}),e.jsx("td",{className:"border-b px-4 py-2 text-gray-600",children:t.specs}),e.jsx("td",{className:"border-b px-4 py-2 text-center",children:t.unit}),e.jsx("td",{className:"border-b px-4 py-2 text-right",children:e.jsx("input",{type:"number",min:"0",value:t.quantity,onChange:a=>E(i,"quantity",a.target.value),className:"w-20 border rounded px-2 py-1 text-right bg-yellow-50"})}),e.jsxs("td",{className:"border-b px-4 py-2 text-right",children:["₱",Number(t.unit_price).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),e.jsx("div",{className:`text-xs ${t.priceSource==="Quoted Price"?"text-green-600":"text-gray-500"}`,children:t.priceSource})]}),e.jsxs("td",{className:"border-b px-4 py-2 text-right",children:["₱",(t.unit_price*t.quantity).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},`${r.id}-${t.pr_detail_id}`)),e.jsxs("tr",{className:"bg-gray-100 font-semibold",children:[e.jsx("td",{colSpan:"5",className:"border-t px-4 py-2 text-right",children:"Supplier Total:"}),e.jsxs("td",{className:"border-t border-r px-4 py-2 text-right",children:["₱",(()=>{const t=c.filter(n=>n.supplier_id===r.id);return t.some(n=>n.mode==="as-calculated"&&n.total_price_calculated!=null)?Number(t[0].total_price_calculated).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}):s.reduce((n,x)=>n+Number(x.total_price),0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})})()]})]})]})]})})]},r.id)}),e.jsx(o,{type:"submit",disabled:p||u.items.length===0,className:"mt-6",children:p?"Submitting...":"Submit Purchase Order"})]}),e.jsx(C,{open:R,onOpenChange:m,children:e.jsxs(D,{children:[e.jsxs(v,{children:[e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"text-yellow-500"}),"Confirm Submission"]}),e.jsx(O,{className:"pt-4 text-base",children:"Are you sure you want to create this Purchase Order? Please review the items and quantities before proceeding."})]}),e.jsxs(I,{children:[e.jsx(o,{variant:"outline",onClick:()=>m(!1),children:"Cancel"}),e.jsx(o,{onClick:k,disabled:p,className:"bg-green-600 hover:bg-green-700",children:p?"Submitting...":"Confirm & Create PO"})]})]})}),e.jsx(C,{open:F,onOpenChange:d,children:e.jsxs(D,{children:[e.jsxs(v,{children:[e.jsx(P,{children:"Reason for Quantity Change"}),e.jsx(O,{className:"pt-2",children:"You changed the quantity from the original PR. Please provide a reason for this adjustment."})]}),e.jsx("textarea",{value:f,onChange:r=>y(r.target.value),className:"w-full border rounded px-3 py-2 mt-3",rows:"3",placeholder:"Enter reason..."}),e.jsxs(I,{children:[e.jsx(o,{variant:"outline",onClick:()=>{d(!1),b(null),y("")},children:"Cancel"}),e.jsx(o,{onClick:L,disabled:!f.trim(),className:"bg-blue-600 hover:bg-blue-700",children:"Save Change"})]})]})})]})}export{le as default};
