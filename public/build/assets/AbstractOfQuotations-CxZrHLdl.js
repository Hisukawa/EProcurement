import{r as n,j as e,H as ye,b as y}from"./app-DIwoxpaE.js";import{A as ke}from"./ApproverLayout-CGHvZpAB.js";import{D as k,a as v,b as N,c as w,d as C,e as S}from"./dialog-DwNzt0uL.js";import{B as l}from"./button-CjfOPFJT.js";import{T as H}from"./textarea-JEzxXLhT.js";import{u as ve}from"./use-toast-D792B5D_.js";import{A as Ne}from"./AOQTabs-DlxsKjEm.js";import"./Dropdown-BMMSVb61.js";import"./transition-DVuHuDAs.js";import"./toaster-D1ZsEoEm.js";import"./index-YfQ8JO5P.js";import"./index-bwz3em9E.js";import"./createLucideIcon-CwZjMAiL.js";import"./index-COOQ74f6.js";import"./index-1vRbBC7m.js";import"./XMarkIcon-4qo16GRs.js";import"./ClipboardDocumentIcon-lbCQHPom.js";import"./clipboard-check-B2B1HcCU.js";import"./circle-check-big-Ds09wOyZ.js";import"./file-text-NZ4MJ1kq.js";import"./BellAlertIcon-BcBia_ua.js";import"./index-XJhwhCu2.js";function Ye({rfq:c,groupedDetails:_={},committee:u}){var ae;const p=c.purchase_request,[ie,R]=n.useState(!1),[I,W]=n.useState(""),[O,x]=n.useState({open:!1,type:"success",title:"",description:""}),[F,ne]=n.useState({rfqId:null,supplierId:null,detailId:null}),[le,D]=n.useState(!1),{toast:g}=ve(),[m,oe]=n.useState(null),[P,M]=n.useState(""),[d,T]=n.useState(c.award_mode??"whole-pr"),[Q,de]=n.useState(()=>{const s={};return["secretariat","member1","member2","member3","vice_chair","chair"].forEach(a=>{var i,o;const r=(o=(i=u==null?void 0:u.members)==null?void 0:i.filter(h=>h.position===a))==null?void 0:o.find(h=>h.status==="active");s[a]={name:(r==null?void 0:r.name)||"",status:(r==null?void 0:r.status)||"inactive"}}),{status:(u==null?void 0:u.status)||"draft",members:s}}),[ce,A]=n.useState(!1),[V,pe]=n.useState(null),[Y,B]=n.useState(!1),[G,z]=n.useState(!1),[J,K]=n.useState(!1),[we,Ce]=n.useState("as-read"),X=(s,t,a=null)=>{pe({rfqId:s,supplierId:t,detailId:a}),W(""),A(!0)},me=()=>{z(!0);const s={remarks:I,mode:d,...d==="per-item"?{detail_id:V.detailId}:{}};y.post(route("bac_approver.rollback_winner",{id:V.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{A(!1),z(!1),x({open:!0,type:"success",title:"Rollback Successful",description:"Winner selection has been rolled back."}),g({title:"Rollback Successful",description:"Winner selection has been rolled back.",duration:3e3})},onError:()=>{z(!1),x({open:!0,type:"error",title:"Rollback Failed",description:"Unable to rollback winner. Please try again."})}})},ue=s=>window.open(route("bac_approver.print_aoq",{id:s}),"_blank"),xe=(s,t)=>window.open(route("bac_approver.print_aoq",{id:s,pr_detail_id:t}),"_blank"),Z=(s,t,a=null)=>{ne({rfqId:s,supplierId:t,detailId:a}),W(""),R(!0)},he=async()=>{K(!0);const s={supplier_id:F.supplierId,remarks:I,mode:d,...d==="per-item"?{detail_id:F.detailId}:{}};try{(await axios.post(route("bac_approver.mark_winner",{id:F.rfqId}),s)).data.success&&(R(!1),x({open:!0,type:"success",title:"Winner Marked",description:d==="per-item"?"Supplier has been awarded for the selected item.":"Supplier has been awarded for the entire PR."}),g({title:"Winner Marked",description:d==="per-item"?"Supplier has been awarded for the selected item.":"Supplier has been awarded for the entire PR.",duration:3e3}),y.reload({preserveScroll:!0}))}catch{K(!1),x({open:!0,type:"error",title:"Failed to Mark Winner",description:"Something went wrong while marking the winner. Please try again."})}},j={},$={};p.details.forEach(s=>{(_[s.id]||[]).forEach(a=>{const r=a.supplier.id;j[r]||(j[r]={supplier:a.supplier,detailIds:new Set,total:0,quotes:[]},$[r]=0),j[r].detailIds.add(s.id),j[r].total+=parseFloat(a.quoted_price||0),j[r].quotes.push(a),a.is_winner&&$[r]++})});const ee=p.details.length,b=Object.values(j).filter(s=>s.detailIds.size===ee),U=b.length>0;n.useEffect(()=>{!U&&d==="whole-pr"&&T("per-item")},[U,d]);const be=p.details.some(s=>(_[s.id]||[]).some(t=>t.is_winner)),[je,f]=n.useState(!1),[E,se]=n.useState(null),[re,L]=n.useState(""),[te,q]=n.useState(!1),ge=()=>{q(!0);const s={supplier_id:E.supplierId,remarks:re,mode:d,...E.detailId!==null?{detail_id:E.detailId}:{}};y.post(route("bac_approver.save_remarks",{id:E.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{q(!1),f(!1),g({title:"Remarks Saved",description:"Supplier remarks updated successfully.",duration:3e3}),y.reload({only:["rfq","groupedDetails"]})},onError:()=>{q(!1),g({title:"Save Failed",description:"Could not save remarks. Please try again.",variant:"destructive",duration:3e3})}})};return e.jsxs(ke,{children:[e.jsx(ye,{title:`Abstract for ${p.pr_number}`}),e.jsxs("div",{className:"px-8 py-10",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-6",children:["Abstract of Quotations â€“ PR #",p.pr_number]}),e.jsx(Ne,{pr:p.id}),e.jsx("div",{className:"mb-4 flex justify-between items-center",children:e.jsx("button",{onClick:()=>window.history.back(),className:"inline-flex items-center px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-md text-sm shadow-sm",children:"â† Back"})}),e.jsxs("div",{className:"mb-6 flex gap-4",children:[e.jsx(l,{variant:d==="whole-pr"?"default":"outline",onClick:()=>T("whole-pr"),disabled:!!c.award_mode,children:"Winner for Entire PR"}),e.jsx(l,{variant:d==="per-item"?"default":"outline",onClick:()=>T("per-item"),disabled:!!c.award_mode,children:"Winner per Item"})]}),!U&&e.jsx("p",{className:"text-sm text-red-600 mb-4",children:"âš ï¸ No supplier quoted for all items. You can only declare winners per item."}),d==="whole-pr"&&e.jsxs("div",{className:"mb-10 border p-4 rounded-lg bg-white shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Comparison for Entire Purchase Request"}),e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Focal Person:"})," ",p.focal_person.firstname," ",p.focal_person.lastname]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Division:"})," ",p.division.division]})]}),b.length===1&&e.jsx("p",{className:"mt-2 text-sm text-orange-600 font-medium",children:"âš ï¸ Note: Only one supplier submitted quotes for the entire PR."})]}),e.jsx("button",{onClick:()=>ue(c.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md h-fit",children:"ðŸ–¨ï¸ Print Abstract as Read"})]}),e.jsxs("table",{className:"w-full text-sm border border-gray-300 rounded-lg overflow-hidden shadow",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-4 py-3 text-left font-semibold",children:"Item"}),b.map(s=>e.jsx("th",{className:"border px-4 py-3 text-center font-semibold text-xs w-56",children:s.supplier.company_name},s.supplier.id))]})}),e.jsxs("tbody",{children:[p.details.map((s,t)=>{const a=_[s.id]||[],r=a.reduce((i,o)=>!i||parseFloat(o.quoted_price)<parseFloat(i.quoted_price)?o:i,null);return e.jsxs("tr",{className:t%2===0?"bg-white":"bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-2 font-medium",children:s.item}),b.map(i=>{const o=a.find(fe=>fe.supplier.id===i.supplier.id),h=o&&r&&o.supplier.id===r.supplier.id;return e.jsx("td",{className:`border px-4 py-2 text-center align-top ${h?"bg-green-50":""}`,children:o?e.jsxs("span",{className:`font-semibold ${h?"text-green-700":"text-gray-800"}`,children:["â‚±",parseFloat(o.quoted_price).toLocaleString()]}):e.jsx("span",{className:"text-gray-400",children:"â€”"})},i.supplier.id)})]},s.id)}),e.jsxs("tr",{className:"bg-gray-200 font-semibold",children:[e.jsx("td",{className:"border px-4 py-3 text-right",children:"Total Quoted Price"}),b.map(s=>e.jsxs("td",{className:"border px-4 py-3 text-right text-green-700",children:["â‚±",parseFloat(s.total).toLocaleString()]},s.supplier.id))]}),e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-3 text-right font-semibold",children:"Supplier Remarks"}),b.map(s=>{const t=s.quotes.filter(i=>i.rfq_id===c.id).map(i=>{var o;return((o=i.remarks)==null?void 0:o.trim())||""}),r=t.every((i,o,h)=>i===h[0])&&t.length>0?t[0]||"No remarks":"Varying remarks (edit to unify)";return e.jsx("td",{className:"border px-4 py-3 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-xs text-gray-600 italic",children:r}),e.jsx(l,{size:"xs",variant:"outline",className:"px-2 py-1",onClick:()=>{se({rfqId:c.id,supplierId:s.supplier.id,detailId:null,currentRemarks:r==="No remarks"||r.includes("Varying")?"":r}),L(r==="No remarks"||r.includes("Varying")?"":r),f(!0)},children:"Edit Remarks"})]})},`remarks-${s.supplier.id}`)})]}),e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("td",{className:"border px-4 py-3 text-right font-semibold",children:"Winner"}),b.map(s=>e.jsx("td",{className:"border px-4 py-3 text-center",children:$[s.supplier.id]===ee?e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-green-600 font-bold",children:"âœ” Winner"}),e.jsx(l,{size:"sm",variant:"destructive",onClick:()=>X(c.id,s.supplier.id),children:"Rollback"})]}):be?"â€”":e.jsx(l,{size:"sm",onClick:()=>Z(c.id,s.supplier.id),children:"Mark as Winner"})},s.supplier.id))]})]})]})]}),d==="per-item"&&e.jsx("div",{className:"space-y-8 mb-10 border p-4 rounded-lg bg-white shadow-sm",children:p.details.map(s=>{const t=_[s.id]||[],a=t.some(r=>r.is_winner);return e.jsxs("div",{className:"border p-4 bg-white rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h4",{className:"font-semibold",children:s.item}),e.jsx("button",{onClick:()=>xe(c.id,s.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md",children:"ðŸ–¨ï¸ Print AOQ"})]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[e.jsx("strong",{children:"Description:"})," ",s.specs||"â€”"," ",e.jsx("br",{}),e.jsx("strong",{children:"Quantity:"})," ",s.quantity," ",s.unit," ",e.jsx("br",{})]}),e.jsxs("table",{className:"w-full text-sm border rounded-lg overflow-hidden shadow",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Supplier"})," ",t.map(r=>e.jsx("th",{className:"px-4 py-2 text-center",children:r.supplier.company_name},r.supplier.id))]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:"Quoted Price"}),t.map(r=>e.jsx("td",{className:"px-4 py-2 text-center align-top",children:e.jsxs("span",{className:"font-semibold text-gray-800",children:["â‚±",parseFloat(r.quoted_price||0).toLocaleString()]})},r.supplier.id))]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:"Remarks"}),t.map(r=>{var o;const i=((o=r.remarks)==null?void 0:o.trim())||"No remarks";return e.jsx("td",{className:"px-4 py-2 text-center align-top",children:e.jsxs("div",{className:"flex flex-col gap-1 items-center",children:[e.jsx("span",{className:"text-xs text-gray-600 italic",children:i}),e.jsx(l,{size:"xs",variant:"outline",className:"px-2 py-1",onClick:()=>{se({rfqId:c.id,supplierId:r.supplier.id,detailId:s.id,currentRemarks:i==="No remarks"?"":i}),L(i==="No remarks"?"":i),f(!0)},children:"Edit"})]})},`item-remarks-${r.supplier.id}`)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:"Winner Status"}),t.map(r=>e.jsx("td",{className:"px-4 py-2 text-center align-top",children:r.is_winner?e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-green-600 font-bold",children:"âœ” Winner"}),e.jsx(l,{size:"sm",variant:"destructive",onClick:()=>X(c.id,r.supplier.id,s.id),children:"Rollback"})]}):a?e.jsx("span",{className:"text-gray-400",children:"â€”"}):e.jsx(l,{size:"sm",onClick:()=>Z(c.id,r.supplier.id,s.id),children:"Mark as Winner"})},`item-winner-${r.supplier.id}`))]})]})]})]},s.id)})}),e.jsxs("div",{className:"mb-8 p-4 border rounded-lg bg-gray-50 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"BAC Committee"}),e.jsx("ul",{className:"space-y-3",children:["chair","vice_chair","secretariat","member1","member2","member3"].map(s=>{const t=Q.members[s];return(t==null?void 0:t.status)==="active"&&e.jsxs("li",{className:"flex items-center justify-between bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.name||"â€”"}),e.jsx("p",{className:"text-sm text-gray-500",children:s.replace("_"," ").toUpperCase()})]}),e.jsx(l,{variant:"outline",size:"sm",onClick:()=>{oe({position:s,current:t}),M(""),D(!0)},children:"Replace"})]},s)})})]})]}),e.jsx(k,{open:ie,onOpenChange:R,children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(w,{children:"Confirm Winner"}),e.jsx(C,{children:"Provide remarks for awarding this supplier."})]}),e.jsx(H,{value:I,onChange:s=>W(s.target.value)}),e.jsxs(S,{children:[e.jsx(l,{variant:"secondary",onClick:()=>R(!1),children:"Cancel"}),e.jsx(l,{disabled:J,onClick:he,children:J?"Confirming Winner...":"Confirm"})]})]})}),e.jsx(k,{open:le,onOpenChange:D,children:e.jsxs(v,{className:"sm:max-w-md",children:[e.jsxs(N,{children:[e.jsx(w,{children:"Replace Committee Member"}),e.jsxs(C,{children:["Enter a new member to replace"," ",e.jsx("strong",{children:((ae=m==null?void 0:m.current)==null?void 0:ae.name)||"N/A"})," (",m==null?void 0:m.position.replace("_"," ").toUpperCase(),")."]})]}),e.jsx("input",{type:"text",value:P,onChange:s=>M(s.target.value),placeholder:"Enter new member name",className:"w-full border px-3 py-2 rounded mb-2"}),e.jsxs(S,{className:"mt-4",children:[e.jsx(l,{variant:"secondary",onClick:()=>D(!1),children:"Cancel"}),e.jsx(l,{disabled:Y,onClick:()=>{if(!P.trim())return;B(!0),de(t=>({...t,members:{...t.members,[m.position]:{name:P.trim(),status:"active"}}}));const s={id:(u==null?void 0:u.id)??null,status:Q.status,members:Object.entries({...Q.members,[m.position]:{name:P.trim(),status:"active"}}).map(([t,a])=>({position:t,name:a.name,status:a.status}))};y.post(route("bac.committee.save"),s,{preserveScroll:!0,onSuccess:()=>{B(!1),D(!1),x({open:!0,type:"success",title:"Committee Updated",description:`${m.position.replace("_"," ")} replaced successfully.`}),g({title:"Committee Updated",description:`${m.position.replace("_"," ")} replaced successfully.`,duration:3e3})},onError:()=>{B(!1),x({open:!0,type:"error",title:"Committee Update Failed",description:"Unable to replace committee member. Please try again."})}})},children:Y?"Saving...":"Confirm"})]})]})}),e.jsx(k,{open:ce,onOpenChange:A,children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(w,{children:"Rollback Winner"}),e.jsx(C,{children:"Provide remarks for rolling back this winner selection."})]}),e.jsx(H,{value:I,onChange:s=>W(s.target.value)}),e.jsxs(S,{children:[e.jsx(l,{variant:"secondary",onClick:()=>A(!1),children:"Cancel"}),e.jsx(l,{disabled:G,variant:"destructive",onClick:me,children:G?"Rolling Back Winner...":"Confirm Rollback"})]})]})}),e.jsx(k,{open:O.open,onOpenChange:s=>x(t=>({...t,open:s})),children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(w,{className:O.type==="error"?"text-red-600":"text-green-600",children:O.title}),e.jsx(C,{children:O.description})]}),e.jsx(S,{children:e.jsx(l,{onClick:()=>x(s=>({...s,open:!1})),children:"Close"})})]})}),e.jsx(k,{open:je,onOpenChange:f,children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(w,{children:"Edit Supplier Remarks"}),e.jsxs(C,{children:["Enter remarks for this supplier ",d==="per-item"?"on this item":"for the PR","."]})]}),e.jsx(H,{value:re,onChange:s=>L(s.target.value)}),e.jsxs(S,{children:[e.jsx(l,{variant:"secondary",onClick:()=>f(!1),children:"Cancel"}),e.jsx(l,{disabled:te,onClick:ge,children:te?"Saving...":"Save"})]})]})})]})}export{Ye as default};
