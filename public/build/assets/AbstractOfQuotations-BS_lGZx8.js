import{r as n,j as e,H as ye,b as y}from"./app-z2zUCIH2.js";import{A as ke}from"./ApproverLayout-BWAl6bbY.js";import{D as k,a as N,b as v,c as w,d as _,e as S}from"./dialog-Dc_xfRUc.js";import{B as o}from"./button-BxtF8k1k.js";import{T as L}from"./textarea-CK-8NHh2.js";import{u as Ne}from"./use-toast-Byxe34qQ.js";import{A as ve,U as we}from"./AOQTabs-CwvL76yC.js";import"./Dropdown-DTp9JO5b.js";import"./transition-Mdjj0t_f.js";import"./toaster-De5hWt1k.js";import"./index-CMYY62sn.js";import"./index-BPRSbHGy.js";import"./createLucideIcon-B5xgoSjl.js";import"./utils-Cf4Ri238.js";import"./index-ZeHC1oZz.js";import"./XMarkIcon--6nDV5HQ.js";import"./ClipboardDocumentIcon-BLqeaTjg.js";import"./clipboard-check-DtUsxnJ2.js";import"./circle-check-big-DQEOxSAl.js";import"./file-text-D_Ew3EzO.js";import"./BellAlertIcon-Bm8_xukv.js";import"./index-DDOX9kOw.js";function Ge({rfq:d,groupedDetails:C={},committee:u}){var ae;const p=d.purchase_request,[ie,R]=n.useState(!1),[I,W]=n.useState(""),[O,x]=n.useState({open:!1,type:"success",title:"",description:""}),[F,ne]=n.useState({rfqId:null,supplierId:null,detailId:null}),[le,D]=n.useState(!1),{toast:g}=Ne(),[m,oe]=n.useState(null),[P,M]=n.useState(""),[c,H]=n.useState(d.award_mode??"whole-pr"),[T,de]=n.useState(()=>{const s={};return["secretariat","member1","member2","member3","vice_chair","chair"].forEach(i=>{var a,l;const r=(l=(a=u==null?void 0:u.members)==null?void 0:a.filter(h=>h.position===i))==null?void 0:l.find(h=>h.status==="active");s[i]={name:(r==null?void 0:r.name)||"",status:(r==null?void 0:r.status)||"inactive"}}),{status:(u==null?void 0:u.status)||"draft",members:s}}),[ce,A]=n.useState(!1),[V,pe]=n.useState(null),[Y,U]=n.useState(!1),[G,Q]=n.useState(!1),[J,K]=n.useState(!1),[_e,Se]=n.useState("as-read"),X=(s,t,i=null)=>{pe({rfqId:s,supplierId:t,detailId:i}),W(""),A(!0)},me=()=>{Q(!0);const s={remarks_as_read:I,mode:c,...c==="per-item"?{detail_id:V.detailId}:{}};y.post(route("bac_approver.rollback_winner_as_read",{id:V.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{A(!1),Q(!1),x({open:!0,type:"success",title:"Rollback Successful",description:"Winner selection has been rolled back."}),g({title:"Rollback Successful",description:"Winner selection has been rolled back.",duration:3e3})},onError:()=>{Q(!1),x({open:!0,type:"error",title:"Rollback Failed",description:"Unable to rollback winner. Please try again."})}})},ue=s=>window.open(route("bac_approver.print_aoq",{id:s}),"_blank"),xe=(s,t)=>window.open(route("bac_approver.print_aoq",{id:s,pr_detail_id:t}),"_blank"),Z=(s,t,i=null)=>{ne({rfqId:s,supplierId:t,detailId:i}),W(""),R(!0)},he=async()=>{K(!0);const s={supplier_id:F.supplierId,remarks_as_read:I,mode:c,...c==="per-item"?{detail_id:F.detailId}:{}};try{(await axios.post(route("bac_approver.mark_winner",{id:F.rfqId}),s)).data.success&&(R(!1),x({open:!0,type:"success",title:"Winner Marked",description:c==="per-item"?"Supplier has been awarded for the selected item.":"Supplier has been awarded for the entire PR."}),g({title:"Winner Marked",description:c==="per-item"?"Supplier has been awarded for the selected item.":"Supplier has been awarded for the entire PR.",duration:3e3}),y.reload({preserveScroll:!0}))}catch{K(!1),x({open:!0,type:"error",title:"Failed to Mark Winner",description:"Something went wrong while marking the winner. Please try again."})}},b={},B={};p.details.forEach(s=>{(C[s.id]||[]).forEach(i=>{const r=i.supplier.id;b[r]||(b[r]={supplier:i.supplier,detailIds:new Set,total:0,quotes:[]},B[r]=0),b[r].detailIds.add(s.id);const a=s.quantity??1,l=parseFloat(i.quoted_price??0)||0;b[r].total+=l*a,b[r].quotes.push(i),i.is_winner_as_read&&B[r]++})});const ee=p.details.length,j=Object.values(b).filter(s=>s.detailIds.size===ee),z=j.length>0;n.useEffect(()=>{!z&&c==="whole-pr"&&H("per-item")},[z,c]);const je=p.details.some(s=>(C[s.id]||[]).some(t=>t.is_winner_as_read)),[be,f]=n.useState(!1),[E,se]=n.useState(null),[re,$]=n.useState(""),[te,q]=n.useState(!1),ge=()=>{q(!0);const s={supplier_id:E.supplierId,remarks_as_read:re,mode:c,...E.detailId!==null?{detail_id:E.detailId}:{}};y.post(route("bac_approver.save_remarks_as_read",{id:E.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{q(!1),f(!1),g({title:"Remarks Saved",description:"Supplier remarks updated successfully.",duration:3e3}),y.reload({only:["rfq","groupedDetails"]})},onError:()=>{q(!1),g({title:"Save Failed",description:"Could not save remarks. Please try again.",variant:"destructive",duration:3e3})}})};return e.jsxs(ke,{children:[e.jsx(ye,{title:`Abstract for ${p.pr_number}`}),e.jsxs("div",{className:"px-8 py-10",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-6",children:["Abstract of Quotations â€“ PR #",p.pr_number]}),e.jsx(ve,{pr:p.id}),e.jsx("div",{className:"mb-4 flex justify-between items-center",children:e.jsx("button",{onClick:()=>window.history.back(),className:"inline-flex items-center px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-md text-sm shadow-sm",children:"â† Back"})}),e.jsx("div",{className:"mb-6 flex gap-4",children:e.jsx(o,{variant:c==="whole-pr"?"default":"outline",onClick:()=>H("whole-pr"),disabled:!!d.award_mode,children:"Winner for Entire PR"})}),!z&&e.jsx("p",{className:"text-sm text-red-600 mb-4",children:"âš ï¸ No supplier quoted for all items. You can only declare winners per item."}),c==="whole-pr"&&e.jsxs("div",{className:"mb-10 border p-4 rounded-lg bg-white shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Comparison for Entire Purchase Request"}),e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Focal Person:"})," ",p.focal_person.firstname," ",p.focal_person.lastname]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Division:"})," ",p.division.division]})]}),j.length===1&&e.jsx("p",{className:"mt-2 text-sm text-orange-600 font-medium",children:"âš ï¸ Note: Only one supplier submitted quotes for the entire PR."})]}),e.jsx("button",{onClick:()=>ue(d.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md h-fit",children:"ðŸ–¨ï¸ Print Abstract as Read"})]}),e.jsxs("table",{className:"w-full text-sm border border-gray-300 rounded-lg overflow-hidden shadow",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-4 py-3 text-left font-semibold",children:"Item"}),j.map(s=>e.jsx("th",{className:"border px-4 py-3 text-center font-semibold text-xs w-56",children:s.supplier.company_name},s.supplier.id))]})}),e.jsxs("tbody",{children:[p.details.map((s,t)=>{const i=C[s.id]||[],r=i.reduce((a,l)=>!a||parseFloat(l.quoted_price)<parseFloat(a.quoted_price)?l:a,null);return e.jsxs("tr",{className:t%2===0?"bg-white":"bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-2 font-medium",children:s.item}),j.map(a=>{const l=i.find(fe=>fe.supplier.id===a.supplier.id),h=l&&r&&l.supplier.id===r.supplier.id;return e.jsx("td",{className:`border px-4 py-2 text-center align-top ${h?"bg-green-50":""}`,children:l?e.jsxs("span",{className:`font-semibold ${h?"text-green-700":"text-gray-800"}`,children:[e.jsxs("span",{className:"mr-1",children:["â‚±",Math.round(l.quoted_price).toLocaleString()]}),e.jsx("span",{className:"mx-1",children:"x"}),e.jsx("span",{className:"mr-1",children:s.quantity}),e.jsx("span",{children:s.unit})]}):e.jsx("span",{className:"text-gray-400",children:"â€”"})},a.supplier.id)})]},s.id)}),e.jsxs("tr",{className:"bg-gray-200 font-semibold",children:[e.jsx("td",{className:"border px-4 py-3 text-right",children:"Total Quoted Price Per Unit"}),j.map(s=>e.jsxs("td",{className:"border px-4 py-3 text-right text-green-700",children:["â‚±",parseFloat(s.total).toLocaleString()]},s.supplier.id))]}),e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-3 text-right font-semibold",children:"Supplier Remarks"}),j.map(s=>{const t=s.quotes.filter(a=>a.rfq_id===d.id).map(a=>{var l;return((l=a.remarks_as_read)==null?void 0:l.trim())||""}),r=t.every((a,l,h)=>a===h[0])&&t.length>0?t[0]||"No remarks":"Varying remarks (edit to unify)";return e.jsx("td",{className:"border px-4 py-3 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-xs text-gray-600 italic",children:r}),e.jsx(o,{size:"xs",variant:"outline",className:"px-2 py-1",onClick:()=>{se({rfqId:d.id,supplierId:s.supplier.id,detailId:null,currentRemarks:r==="No remarks"||r.includes("Varying")?"":r}),$(r==="No remarks"||r.includes("Varying")?"":r),f(!0)},children:"Edit Remarks"})]})},`remarks-${s.supplier.id}`)})]}),e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("td",{className:"border px-4 py-3 text-right font-semibold",children:"Winner"}),j.map(s=>e.jsx("td",{className:"border px-4 py-3 text-center",children:B[s.supplier.id]===ee?e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-green-600 font-bold",children:"âœ” Winner"}),e.jsxs(o,{size:"sm",variant:"destructive",onClick:()=>X(d.id,s.supplier.id),disabled:!!d.purchase_order,children:[e.jsx(we,{className:"h-4 w-4"}),"Undo"]})]}):je?"â€”":e.jsx(o,{size:"sm",onClick:()=>Z(d.id,s.supplier.id),children:"Mark as Winner"})},s.supplier.id))]})]})]})]}),c==="per-item"&&e.jsx("div",{className:"space-y-8 mb-10 border p-4 rounded-lg bg-white shadow-sm",children:p.details.map(s=>{const t=C[s.id]||[],i=t.some(r=>r.is_winner_as_read);return e.jsxs("div",{className:"border p-4 bg-white rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h4",{className:"font-semibold",children:s.item}),e.jsx("button",{onClick:()=>xe(d.id,s.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md",children:"ðŸ–¨ï¸ Print AOQ"})]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[e.jsx("strong",{children:"Description:"})," ",s.specs||"â€”"," ",e.jsx("br",{}),e.jsx("strong",{children:"Quantity:"})," ",s.quantity," ",s.unit," ",e.jsx("br",{})]}),e.jsxs("table",{className:"w-full text-sm border rounded-lg overflow-hidden shadow",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Supplier"})," ",t.map(r=>e.jsx("th",{className:"px-4 py-2 text-center",children:r.supplier.company_name},r.supplier.id))]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:"Quoted Price"}),t.map(r=>e.jsx("td",{className:"px-4 py-2 text-center align-top",children:e.jsxs("span",{className:"font-semibold text-gray-800",children:["â‚±",parseFloat(r.quoted_price||0).toLocaleString()]})},r.supplier.id))]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:"Remarks"}),t.map(r=>{var l;const a=((l=r.remarks_as_read)==null?void 0:l.trim())||"No remarks";return e.jsx("td",{className:"px-4 py-2 text-center align-top",children:e.jsxs("div",{className:"flex flex-col gap-1 items-center",children:[e.jsx("span",{className:"text-xs text-gray-600 italic",children:a}),e.jsx(o,{size:"xs",variant:"outline",className:"px-2 py-1",onClick:()=>{se({rfqId:d.id,supplierId:r.supplier.id,detailId:s.id,currentRemarks:a==="No remarks"?"":a}),$(a==="No remarks"?"":a),f(!0)},children:"Edit"})]})},`item-remarks-${r.supplier.id}`)})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:"Winner Status"}),t.map(r=>e.jsx("td",{className:"px-4 py-2 text-center align-top",children:r.is_winner_as_read?e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-green-600 font-bold",children:"âœ” Winner"}),e.jsx(o,{size:"sm",variant:"destructive",onClick:()=>X(d.id,r.supplier.id,s.id),children:"Rollback"})]}):i?e.jsx("span",{className:"text-gray-400",children:"â€”"}):e.jsx(o,{size:"sm",onClick:()=>Z(d.id,r.supplier.id,s.id),children:"Mark as Winner"})},`item-winner-${r.supplier.id}`))]})]})]})]},s.id)})}),e.jsxs("div",{className:"mb-8 p-4 border rounded-lg bg-gray-50 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"BAC Committee"}),e.jsx("ul",{className:"space-y-3",children:["chair","vice_chair","secretariat","member1","member2","member3"].map(s=>{const t=T.members[s];return(t==null?void 0:t.status)==="active"&&e.jsxs("li",{className:"flex items-center justify-between bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.name||"â€”"}),e.jsx("p",{className:"text-sm text-gray-500",children:s.replace("_"," ").toUpperCase()})]}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>{oe({position:s,current:t}),M(""),D(!0)},children:"Replace"})]},s)})})]})]}),e.jsx(k,{open:ie,onOpenChange:R,children:e.jsxs(N,{children:[e.jsxs(v,{children:[e.jsx(w,{children:"Confirm Winner"}),e.jsx(_,{children:"Provide remarks for awarding this supplier."})]}),e.jsx(L,{value:I,onChange:s=>W(s.target.value)}),e.jsxs(S,{children:[e.jsx(o,{variant:"secondary",onClick:()=>R(!1),children:"Cancel"}),e.jsx(o,{disabled:J,onClick:he,children:J?"Confirming Winner...":"Confirm"})]})]})}),e.jsx(k,{open:le,onOpenChange:D,children:e.jsxs(N,{className:"sm:max-w-md",children:[e.jsxs(v,{children:[e.jsx(w,{children:"Replace Committee Member"}),e.jsxs(_,{children:["Enter a new member to replace"," ",e.jsx("strong",{children:((ae=m==null?void 0:m.current)==null?void 0:ae.name)||"N/A"})," (",m==null?void 0:m.position.replace("_"," ").toUpperCase(),")."]})]}),e.jsx("input",{type:"text",value:P,onChange:s=>M(s.target.value),placeholder:"Enter new member name",className:"w-full border px-3 py-2 rounded mb-2"}),e.jsxs(S,{className:"mt-4",children:[e.jsx(o,{variant:"secondary",onClick:()=>D(!1),children:"Cancel"}),e.jsx(o,{disabled:Y,onClick:()=>{if(!P.trim())return;U(!0),de(t=>({...t,members:{...t.members,[m.position]:{name:P.trim(),status:"active"}}}));const s={id:(u==null?void 0:u.id)??null,status:T.status,members:Object.entries({...T.members,[m.position]:{name:P.trim(),status:"active"}}).map(([t,i])=>({position:t,name:i.name,status:i.status}))};y.post(route("bac.committee.save"),s,{preserveScroll:!0,onSuccess:()=>{U(!1),D(!1),x({open:!0,type:"success",title:"Committee Updated",description:`${m.position.replace("_"," ")} replaced successfully.`}),g({title:"Committee Updated",description:`${m.position.replace("_"," ")} replaced successfully.`,duration:3e3})},onError:()=>{U(!1),x({open:!0,type:"error",title:"Committee Update Failed",description:"Unable to replace committee member. Please try again."})}})},children:Y?"Saving...":"Confirm"})]})]})}),e.jsx(k,{open:ce,onOpenChange:A,children:e.jsxs(N,{children:[e.jsxs(v,{children:[e.jsx(w,{children:"Rollback Winner"}),e.jsx(_,{children:"Provide remarks for rolling back this winner selection."})]}),e.jsx(L,{value:I,onChange:s=>W(s.target.value)}),e.jsxs(S,{children:[e.jsx(o,{variant:"secondary",onClick:()=>A(!1),children:"Cancel"}),e.jsx(o,{disabled:G,variant:"destructive",onClick:me,children:G?"Rolling Back Winner...":"Confirm Rollback"})]})]})}),e.jsx(k,{open:O.open,onOpenChange:s=>x(t=>({...t,open:s})),children:e.jsxs(N,{children:[e.jsxs(v,{children:[e.jsx(w,{className:O.type==="error"?"text-red-600":"text-green-600",children:O.title}),e.jsx(_,{children:O.description})]}),e.jsx(S,{children:e.jsx(o,{onClick:()=>x(s=>({...s,open:!1})),children:"Close"})})]})}),e.jsx(k,{open:be,onOpenChange:f,children:e.jsxs(N,{children:[e.jsxs(v,{children:[e.jsx(w,{children:"Edit Supplier Remarks"}),e.jsxs(_,{children:["Enter remarks for this supplier ",c==="per-item"?"on this item":"for the PR","."]})]}),e.jsx(L,{value:re,onChange:s=>$(s.target.value)}),e.jsxs(S,{children:[e.jsx(o,{variant:"secondary",onClick:()=>f(!1),children:"Cancel"}),e.jsx(o,{disabled:te,onClick:ge,children:te?"Saving...":"Save"})]})]})})]})}export{Ge as default};
