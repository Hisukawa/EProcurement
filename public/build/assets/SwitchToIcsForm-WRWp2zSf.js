import{a as ne,u as le,j as t}from"./app-B7_UX2sh.js";import{u as oe}from"./use-toast-B7jOcQUg.js";import V from"./AutoCompleteInput-C_J4XxGW.js";import{F as de}from"./file-text-BPUpHXKY.js";import{S as ce}from"./send-horizontal-lNvVmj8S.js";import"./createLucideIcon-Bz5E4J9E.js";function xe({ics:s,user:N,ppeOptions:k,type:X}){var E,A,P,$,F,T,G,L,O,z,D,R,B,H,M,Q,U,W,Y,J;const{toast:x}=oe(),[Z,S]=ne.useState(!1),ee=`${((F=($=(P=(A=(E=s==null?void 0:s.po)==null?void 0:E.details[0])==null?void 0:A.pr_detail)==null?void 0:P.purchase_request)==null?void 0:$.focal_person)==null?void 0:F.firstname)??""} ${((z=(O=(L=(G=(T=s==null?void 0:s.po)==null?void 0:T.details[0])==null?void 0:G.pr_detail)==null?void 0:L.purchase_request)==null?void 0:O.focal_person)==null?void 0:z.middlename)??""} ${((M=(H=(B=(R=(D=s==null?void 0:s.po)==null?void 0:D.details[0])==null?void 0:R.pr_detail)==null?void 0:B.purchase_request)==null?void 0:H.focal_person)==null?void 0:M.lastname)??""}`.trim()||"N/A";(U=(Q=s==null?void 0:s.requested_by)==null?void 0:Q.division)==null||U.division;const{data:c,setData:m,post:te,processing:I,errors:q}=le({id:(s==null?void 0:s.id)??"",type:X||"ics",po_id:((W=s==null?void 0:s.po)==null?void 0:W.id)??null,ics_number:((Y=s==null?void 0:s.po)==null?void 0:Y.po_number)??"",requested_by:((J=s==null?void 0:s.requested_by)==null?void 0:J.id)??N.id,received_from:(N==null?void 0:N.id)??null,remarks:"",items:((s==null?void 0:s.items)||[]).map(e=>{var r;return{inventory_item_id:((r=e==null?void 0:e.inventory_item)==null?void 0:r.id)??null,inventory_item_number:(e==null?void 0:e.inventory_item_number)??"",quantity:(e==null?void 0:e.quantity)??0,unit_cost:(e==null?void 0:e.unit_cost)??0,total_cost:(e==null?void 0:e.total_cost)??0,ppe_sub_major_account:(e==null?void 0:e.ppe_sub_major_account)??null,general_ledger_account:(e==null?void 0:e.general_ledger_account)??null,office:(e==null?void 0:e.office)??null,school:(e==null?void 0:e.school)??null,series_number:(e==null?void 0:e.series_number)??"0001",generated_number:(e==null?void 0:e.generated_number)??""}})});window.__globalSeriesCache||(window.__globalSeriesCache=null);const se=async e=>{var y,_,f;const r=c.items[e],{ppe:p,gl:u,office:o,school:d,inventory_item_number:g}=r;if(g&&g.trim()!==""){x({title:"Already generated",description:"This item already has an inventory number.",variant:"default"});return}if(!p||!u){x({title:"Missing selection",description:"Please select PPE and GL before generating.",variant:"destructive"});return}try{let i=1;if(window.__globalSeriesCache)window.__globalSeriesCache++,i=window.__globalSeriesCache;else{const j=await fetch("/api/ics-next-series"),C=await j.json();if(!j.ok||!C.series)throw new Error("Invalid response from server.");i=C.series,window.__globalSeriesCache=i}const v=i.toString().padStart(4,"0"),a=new Date().getFullYear().toString(),n=((y=p==null?void 0:p.code)==null?void 0:y.padStart(2,"0"))||"00",l=((_=u==null?void 0:u.code)==null?void 0:_.padStart(2,"0"))||"00",h=((f=o==null?void 0:o.code)==null?void 0:f.padStart(2,"0"))||"",b=(o==null?void 0:o.name)==="Schools"&&(d!=null&&d.code)?d.code.padStart(2,"0"):"",w=[a,n,l,v,h];b&&w.push(b);const K=w.filter(Boolean).join("-");m("items",c.items.map((j,C)=>C===e?{...j,series_number:v,inventory_item_number:K,generated_number:K,ppe_sub_major_account:p.name,general_ledger_account:u.name,office:(o==null?void 0:o.name)??"",school:(d==null?void 0:d.name)??""}:j))}catch(i){console.error("Series generation failed:",i),x({title:"⚠️ Warning",description:"Failed to fetch next series number.",variant:"destructive"})}},ae=e=>{e.preventDefault(),S(!0)},re=()=>{te(route("supply_officer.switch_to_ics"),{preserveScroll:!0,onSuccess:()=>{x({title:"✅ Success",description:"ICS issuance submitted successfully!",className:"bg-green-600 text-white"}),S(!1)},onError:()=>{x({title:"❌ Error",description:"Failed to submit ICS issuance.",variant:"destructive"}),S(!1)}})};return t.jsxs("div",{className:"bg-blue-50 p-8 rounded-xl shadow-md",children:[t.jsxs("h2",{className:"text-3xl font-bold text-blue-800 mb-1 flex items-center gap-2",children:[t.jsx(de,{size:24})," Inventory Custodian Slip (ICS)"]}),t.jsxs("p",{className:"text-sm text-gray-700 mb-6",children:[t.jsx("strong",{children:"Note:"})," Each item must have PPE, GL, and location before generation."]}),Object.keys(q).length>0&&t.jsx("div",{className:"bg-red-100 text-red-700 p-4 rounded mb-4",children:t.jsx("ul",{className:"list-disc list-inside",children:Object.entries(q).map(([e,r])=>t.jsx("li",{children:r},e))})}),t.jsxs("form",{onSubmit:ae,className:"space-y-8",children:[c.items.map((e,r)=>{var u,o,d,g,y,_,f,i,v;const p=((o=(u=s.items[r])==null?void 0:u.inventory_item)==null?void 0:o.item_desc)??"N/A";return t.jsxs("div",{className:"border border-gray-300 bg-white rounded-lg p-6 shadow-sm",children:[t.jsxs("h3",{className:"text-lg font-semibold mb-4 text-blue-700",children:["Item ",r+1,": ",p]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Quantity"}),t.jsx("input",{type:"number",value:e.quantity,onChange:a=>m("items",c.items.map((n,l)=>l===r?{...n,quantity:a.target.value}:n)),className:"w-full mt-1 px-3 py-2 border rounded-md"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Unit Cost"}),t.jsx("input",{type:"number",value:e.unit_cost,onChange:a=>m("items",c.items.map((n,l)=>l===r?{...n,unit_cost:a.target.value}:n)),className:"w-full mt-1 px-3 py-2 border rounded-md"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Total Cost"}),t.jsx("input",{type:"number",value:e.total_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md bg-gray-100"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Requested By"}),t.jsx("input",{type:"text",value:ee,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md bg-gray-100"})]})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"PPE Sub-major Account"}),t.jsxs("select",{value:((d=e.ppe)==null?void 0:d.id)||"",onChange:a=>{const n=k.find(l=>l.id==a.target.value);m("items",c.items.map((l,h)=>h===r?{...l,ppe:n,gl:null}:l))},className:"w-full mt-1 px-3 py-2 border rounded-md",children:[t.jsx("option",{value:"",children:"Select PPE"}),k.map(a=>t.jsx("option",{value:a.id,children:a.code?`${a.code} - ${a.name}`:a.name},a.id))]}),t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"General Ledger Account"}),t.jsxs("select",{value:((g=e.gl)==null?void 0:g.id)||"",onChange:a=>{var l,h;const n=((h=(l=e.ppe)==null?void 0:l.general_ledger_accounts)==null?void 0:h.find(b=>b.id==a.target.value))??null;m("items",c.items.map((b,w)=>w===r?{...b,gl:n}:b))},disabled:!e.ppe,className:"w-full mt-1 px-3 py-2 border rounded-md disabled:bg-gray-100",children:[t.jsx("option",{value:"",children:"Select GL"}),(_=(y=e.ppe)==null?void 0:y.general_ledger_accounts)==null?void 0:_.map(a=>t.jsx("option",{value:a.id,children:a.code?`${a.code} - ${a.name}`:a.name},a.id))]}),t.jsx(V,{label:"Location Office",apiRoute:"/api/office-search",value:((f=e.office)==null?void 0:f.code)||"",onChange:a=>m("items",c.items.map((n,l)=>l===r?{...n,office:a}:n)),placeholder:"Type Location Office..."}),((i=e.office)==null?void 0:i.name)==="Schools"&&t.jsx(V,{label:"School",apiRoute:"/api/school-search",value:((v=e.school)==null?void 0:v.name)||"",onChange:a=>m("items",c.items.map((n,l)=>l===r?{...n,school:a}:n)),placeholder:"Type School..."}),t.jsx("button",{type:"button",onClick:()=>se(r),disabled:!!e.inventory_item_number,className:`px-3 py-2 text-sm rounded-md ${e.inventory_item_number?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 text-white"}`,children:e.inventory_item_number?"Already Generated":"Generate Inventory No."}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Inventory Item No."}),t.jsx("input",{type:"text",value:e.generated_number||e.inventory_item_number||"",readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md bg-gray-100"})]})]})]})]},r)}),t.jsx("div",{className:"flex justify-end mt-6",children:t.jsxs("button",{type:"submit",disabled:I,className:"inline-flex items-center px-6 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 disabled:opacity-50",children:[t.jsx(ce,{size:16,className:"mr-2"}),I?"Submitting...":"Submit ICS"]})})]}),Z&&t.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50",children:t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md max-w-md w-full",children:[t.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-800",children:"Confirm Submission"}),t.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to submit this ICS issuance?"}),t.jsxs("div",{className:"flex justify-end gap-3",children:[t.jsx("button",{onClick:()=>S(!1),className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300",children:"Cancel"}),t.jsx("button",{onClick:re,className:"px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800",children:"Confirm"})]})]})})]})}export{xe as default};
