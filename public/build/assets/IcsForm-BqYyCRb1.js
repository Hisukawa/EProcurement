import{u as de,a as f,j as e}from"./app-DIvhqflN.js";import{u as ce}from"./use-toast-DOzsFwf_.js";import M from"./AutoCompleteInput-BGPsci_y.js";import{D as me,a as ue,b as pe,c as he,d as xe,e as be}from"./dialog-DRBwyFc1.js";import{B as Y}from"./button-CVYlHGPx.js";import{F as ge}from"./file-text-DjrBmbHl.js";import{M as fe}from"./minus-0c6ObylH.js";import{S as je}from"./send-horizontal-DsURTK2A.js";import"./index-D6H6XJ45.js";import"./index-sHCL6Saa.js";import"./createLucideIcon-BlLWWl-g.js";import"./utils-DmZEVKAZ.js";import"./index-rNSkqM9E.js";function Fe({purchaseOrder:m,inventoryItems:Q=[],user:j,ppeOptions:_=[],icsNumber:x}){var S,k,D,R,O,q,F;const o=((k=(S=m==null?void 0:m.detail)==null?void 0:S.pr_detail)==null?void 0:k.purchase_request)??null,W=o?`${((D=o==null?void 0:o.focal_person)==null?void 0:D.firstname)??""} ${((R=o==null?void 0:o.focal_person)==null?void 0:R.middlename)??""} ${((O=o==null?void 0:o.focal_person)==null?void 0:O.lastname)??""}`.trim():"N/A",{data:n,setData:r,post:J,processing:N,errors:w}=de({po_id:(m==null?void 0:m.id)??null,ics_number:x??"",requested_by:((q=o==null?void 0:o.focal_person)==null?void 0:q.id)??null,received_from:(j==null?void 0:j.id)??null,remarks:"",items:Q.map(s=>{var t;return{inventory_item_id:s.id,recipient:"",recipient_division:"",estimated_useful_life:null,inventory_item_number:"",ppe_sub_major_account:"",general_ledger_account:"",office:"",school:"",quantity:s.total_stock>0?1:0,unit_cost:s.unit_cost??0,total_cost:s.unit_cost??0,series_number:"0001",description:s.item_desc??((t=s.product)==null?void 0:t.item_description)??"N/A",ppe:null,gl:null,officeObj:null,schoolObj:null}})}),[K,b]=f.useState(!1),{toast:C}=ce(),[V,X]=f.useState(""),[Z,G]=f.useState("");f.useEffect(()=>{x&&!n.ics_number&&r("ics_number",x)},[x]);const I=(s,t,a)=>{const d=[...n.items];if(t==="quantity"){let c=parseFloat(a)||0;d[s].quantity=c,d[s].total_cost=c*(d[s].unit_cost??0)}else d[s][t]=a;r("items",d)},P=s=>{r("items",n.items.filter((t,a)=>a!==s))},v=async()=>{const s=n.items.filter(t=>t.ppe&&t.gl&&t.quantity>0);if(s.length)try{const t=s[0],d=await(await fetch(`/api/ics-next-series?ppe=${encodeURIComponent(t.ppe.name.trim())}&gl=${encodeURIComponent(t.gl.name.trim())}`)).json();let c=parseInt(d.series||"0",10);const u=[...n.items];s.forEach(i=>{var T,A,E,z,B,U,H,L;const h=c.toString().padStart(4,"0"),g=new Date().getFullYear().toString(),l=((T=i.ppe.code)==null?void 0:T.padStart(2,"0"))||"00",p=((A=i.gl.code)==null?void 0:A.padStart(2,"0"))||"00",y=((z=(E=i.officeObj)==null?void 0:E.code)==null?void 0:z.padStart(2,"0"))||"",$=((B=i.officeObj)==null?void 0:B.name)==="Schools"&&((U=i.schoolObj)!=null&&U.code)?i.schoolObj.code.padStart(2,"0"):"",ne=[g,l,p,h,y].filter(Boolean).concat($?[$]:[]).join("-"),ie=u.findIndex(re=>re===i);u[ie]={...i,inventory_item_number:ne,series_number:h,ppe_sub_major_account:i.ppe.name,general_ledger_account:i.gl.name,office:((H=i.officeObj)==null?void 0:H.name)||"",school:((L=i.schoolObj)==null?void 0:L.name)||""},c++}),r("items",u)}catch(t){console.error("Error generating inventory numbers",t)}},ee=(s,t)=>{const a=[...n.items];a[s].ppe=t,a[s].gl=null,a[s].ppe_sub_major_account=(t==null?void 0:t.name)||"",a[s].general_ledger_account="",r("items",a)},se=(s,t)=>{const a=[...n.items];a[s].gl=t,a[s].general_ledger_account=(t==null?void 0:t.name)||"",r("items",a),v(s,a[s])},te=(s,t)=>{const a=[...n.items];a[s].officeObj=t,a[s].office=(t==null?void 0:t.name)||"",r("items",a),v(s,a[s])},ae=(s,t)=>{const a=[...n.items];a[s].schoolObj=t,a[s].school=(t==null?void 0:t.name)||"",r("items",a),v(s,a[s])},le=s=>{s.preventDefault(),b(!0)},oe=()=>{J(route("supply_officer.store_ics"),{preserveScroll:!0,onSuccess:()=>{b(!1),C({title:"ICS Recorded",description:"Inventory Custodian Slip successfully saved!",className:"bg-green-600 text-white",duration:3e3})},onError:()=>{C({title:"Save Failed",description:"Please review inputs and try again.",variant:"destructive",duration:4e3})}})};return e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[e.jsxs("h2",{className:"text-3xl font-bold text-blue-800 mb-4 flex items-center gap-2",children:[e.jsx(ge,{size:24})," Inventory Custodian Slip (ICS)"]}),Object.keys(w).length>0&&e.jsx("div",{className:"bg-red-100 text-red-700 p-4 rounded mb-4",children:e.jsx("ul",{className:"list-disc list-inside",children:Object.entries(w).map(([s,t])=>e.jsx("li",{children:t},s))})}),e.jsxs("form",{onSubmit:le,className:"space-y-6",children:[e.jsxs("div",{className:"p-5 border rounded-md bg-blue-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mb-4",children:"ICS Info"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Designation"}),e.jsx("input",{value:((F=o==null?void 0:o.division)==null?void 0:F.division)??"N/A",readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"ICS No."}),e.jsx("input",{type:"text",value:n.ics_number,onChange:s=>r("ics_number",s.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Requested By"}),e.jsx("input",{value:W,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]})]})]}),n.items.map((s,t)=>{var a,d,c,u,i,h,g;return e.jsxs("div",{className:"p-5 border rounded-md bg-green-50 relative",children:[n.items.length>1&&e.jsx("button",{type:"button",onClick:()=>P(t),className:"absolute top-2 right-2 text-red-600 hover:text-red-800",children:e.jsx(fe,{size:20})}),e.jsxs("h3",{className:"text-lg font-semibold text-green-700 mb-4",children:["Item ",t+1]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Description"}),e.jsx("input",{value:s.description,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"PPE Sub-major Account"}),e.jsxs("select",{value:((a=s.ppe)==null?void 0:a.id)||"",onChange:l=>ee(t,_.find(p=>p.id==l.target.value)),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",children:[e.jsx("option",{value:"",children:"Select PPE"}),_.map(l=>e.jsx("option",{value:l.id,children:l.code?`${l.code} - ${l.name}`:l.name},l.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"General Ledger Account"}),e.jsxs("select",{value:((d=s.gl)==null?void 0:d.id)||"",onChange:l=>{var p;return se(t,(p=s.ppe)==null?void 0:p.general_ledger_accounts.find(y=>y.id==l.target.value))},disabled:!s.ppe,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select GL"}),(u=(c=s.ppe)==null?void 0:c.general_ledger_accounts)==null?void 0:u.map(l=>e.jsx("option",{value:l.id,children:l.code?`${l.code} - ${l.name}`:l.name},l.id))]})]}),e.jsx(M,{label:"Location Office",apiRoute:"/api/office-search",value:((i=s.officeObj)==null?void 0:i.code)||"",onChange:l=>te(t,l),placeholder:"Type Location Office..."}),((h=s.officeObj)==null?void 0:h.name)==="Schools"&&e.jsx(M,{label:"School",apiRoute:"/api/school-search",value:((g=s.schoolObj)==null?void 0:g.name)||"",onChange:l=>ae(t,l),placeholder:"Type School..."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Inventory Item No."}),e.jsx("input",{value:s.inventory_item_number||"",readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-100"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Quantity"}),e.jsx("input",{type:"number",min:"1",max:s.total_stock,value:s.quantity,onChange:l=>I(t,"quantity",l.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Unit Cost"}),e.jsx("input",{type:"number",value:s.unit_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Total Cost"}),e.jsx("input",{type:"number",value:s.total_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Estimated Useful Life (years)"}),e.jsx("input",{type:"number",value:s.estimated_useful_life??"",onChange:l=>I(t,"estimated_useful_life",l.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",onWheel:l=>l.currentTarget.blur()})]})]},t)}),e.jsxs("div",{className:"p-5 border rounded-md bg-yellow-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-yellow-700 mb-4",children:"Default Recipient (applied to all items)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Recipient Name"}),e.jsx("input",{type:"text",value:V,onChange:s=>{X(s.target.value),r("items",n.items.map(t=>({...t,recipient:s.target.value})))},placeholder:"Leave blank to issue to requester",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Recipient Division"}),e.jsx("input",{type:"text",value:Z,onChange:s=>{G(s.target.value),r("items",n.items.map(t=>({...t,recipient_division:s.target.value})))},placeholder:"Optional",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remarks"}),e.jsx("textarea",{value:n.remarks,onChange:s=>r("remarks",s.target.value),rows:"4",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",placeholder:"Optional"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"submit",className:"inline-flex items-center px-6 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800",disabled:N,children:[e.jsx(je,{size:16,className:"mr-2"})," ",N?"Saving...":"Submit Issuance"]})})]}),e.jsx(me,{open:K,onOpenChange:b,children:e.jsxs(ue,{className:"sm:max-w-md",children:[e.jsxs(pe,{children:[e.jsx(he,{children:"Confirm Issuance"}),e.jsx(xe,{children:"Are you sure you want to record this ICS issuance?"})]}),e.jsxs(be,{className:"mt-4 flex justify-end gap-2",children:[e.jsx(Y,{variant:"secondary",onClick:()=>b(!1),children:"Cancel"}),e.jsx(Y,{onClick:oe,children:"Yes, Record ICS"})]})]})})]})}export{Fe as default};
