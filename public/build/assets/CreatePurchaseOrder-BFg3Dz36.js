import{a as n,u as L,j as e,H as Q}from"./app-CKujYd7_.js";import{S as $}from"./SupplyOfficerLayout-BW1geYpU.js";import{D as S,a as C,b as D,c as v,d as P,e as O}from"./dialog-BoAiw6q7.js";import{B as l}from"./button-BDytyKvn.js";import{T as A}from"./triangle-alert-7pUWO6MZ.js";import"./toaster-BC5ooZuz.js";import"./use-toast-Bax0zrdw.js";import"./index-BISxdjyy.js";import"./index-Boi0YpkC.js";import"./createLucideIcon-LguoqwsX.js";import"./utils-zLT5xWck.js";import"./index-DK87wXAm.js";import"./Dropdown-CeA5lpHF.js";import"./transition-GwQ5KLRO.js";import"./XMarkIcon-CQ1f9l2a.js";import"./clipboard-check-D6W4U-7k.js";import"./package-check-EqVpNDj7.js";import"./trash-CVU7oZLJ.js";import"./index-BRvPMNG7.js";function le({pr:g,rfq:F,suppliers:b,winners:o}){const f=n.useMemo(()=>[...new Set(o.map(t=>t.supplier_id))],[o]),p=n.useMemo(()=>b.filter(t=>f.includes(t.id)),[b,f]),[I,m]=n.useState(!1),[j,y]=n.useState(null),[u,x]=n.useState(""),[R,c]=n.useState(!1),q=t=>o.filter(s=>s.supplier_id===t).map(s=>({pr_detail_id:s.pr_detail_id,item:s.item,specs:s.specs,unit:s.unit,quantity:s.quantity,unit_price:Number(s.unit_price??0),total_price:Number(s.total_price??0),priceSource:s.unit_price_edited?"As Calculated Price":"Quoted Price",supplier_id:t,supplier_total:s.supplier_total??null})),{data:h,setData:N,post:T,processing:d}=L({rfq_id:F.id,items:[]});n.useEffect(()=>{const t=p.flatMap(i=>q(i.id));N("items",t)},[p]);const U=()=>{if(!j)return;const{index:t,field:i,value:s}=j,a=[...h.items];a[t][i]=s,a[t].total_price=Number(a[t].quantity)*Number(a[t].unit_price),a[t].change_reason=u,N("items",a),y(null),x(""),m(!1)},k=t=>{t.preventDefault(),c(!0)},w=()=>{T(route("supply_officer.store_po"),{onFinish:()=>c(!1)})};return e.jsxs($,{header:"Schools Divisions Office - Ilagan | Create Purchase Order",children:[e.jsx(Q,{title:`Create PO for PR #${g.pr_number}`}),e.jsxs("form",{onSubmit:k,className:"bg-white p-6 rounded shadow mx-auto max-w-6xl",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-6",children:["Create PO for PR #",g.pr_number]}),p.map(t=>{var a,_;const i=h.items.filter(r=>r.supplier_id===t.id);(a=i.find(r=>r.supplier_total!==null))==null||a.supplier_total;const s=((_=o.find(r=>r.supplier_id===t.id))==null?void 0:_.supplier_total)||i.reduce((r,E)=>r+Number(E.total_price),0);return console.log({supplier:t,supplierItems:i,supplierTotal:s}),e.jsxs("div",{className:"mb-8 border rounded-lg shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-3 font-semibold text-lg",children:["Supplier: ",t.company_name]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto border-separate border-spacing-0 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-y border-l px-4 py-2 text-left",children:"Item"}),e.jsx("th",{className:"border-y px-4 py-2 text-left",children:"Specs"}),e.jsx("th",{className:"border-y px-4 py-2 text-center",children:"Unit"}),e.jsx("th",{className:"border-y px-4 py-2 text-right",children:"Quantity"}),e.jsx("th",{className:"border-y px-4 py-2 text-right",children:"Unit Price"}),e.jsx("th",{className:"border-y px-4 py-2 text-right",children:"Total Price"})]})}),e.jsxs("tbody",{children:[i.map(r=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border-b border-l px-4 py-2",children:r.item}),e.jsx("td",{className:"border-b px-4 py-2 text-gray-600",children:r.specs}),e.jsx("td",{className:"border-b px-4 py-2 text-center",children:r.unit}),e.jsx("td",{className:"border-b px-4 py-2 text-right",children:r.quantity}),e.jsxs("td",{className:"border-b px-4 py-2 text-right",children:["₱",Number(r.unit_price).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),e.jsx("div",{className:`text-xs ${r.priceSource==="Quoted Price"?"text-green-600":"text-gray-500"}`,children:r.priceSource})]}),e.jsxs("td",{className:"border-b px-4 py-2 text-right",children:["₱",(r.unit_price*r.quantity).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},`${t.id}-${r.pr_detail_id}`)),e.jsxs("tr",{className:"bg-gray-100 font-semibold",children:[e.jsx("td",{colSpan:"5",className:"border-t px-4 py-2 text-right",children:"Supplier Total:"}),e.jsxs("td",{className:"border-t border-r px-4 py-2 text-right",children:["₱",s.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]})})]},t.id)}),e.jsx(l,{type:"submit",disabled:d||h.items.length===0,className:"mt-6",children:d?"Submitting...":"Submit Purchase Order"})]}),e.jsx(S,{open:R,onOpenChange:c,children:e.jsxs(C,{children:[e.jsxs(D,{children:[e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"text-yellow-500"}),"Confirm Submission"]}),e.jsx(P,{className:"pt-4 text-base",children:"Are you sure you want to create this Purchase Order? Please review the items and quantities before proceeding."})]}),e.jsxs(O,{children:[e.jsx(l,{variant:"outline",onClick:()=>c(!1),children:"Cancel"}),e.jsx(l,{onClick:w,disabled:d,className:"bg-green-600 hover:bg-green-700",children:d?"Submitting...":"Confirm & Create PO"})]})]})}),e.jsx(S,{open:I,onOpenChange:m,children:e.jsxs(C,{children:[e.jsxs(D,{children:[e.jsx(v,{children:"Reason for Quantity Change"}),e.jsx(P,{className:"pt-2",children:"You changed the quantity from the original PR. Please provide a reason for this adjustment."})]}),e.jsx("textarea",{value:u,onChange:t=>x(t.target.value),className:"w-full border rounded px-3 py-2 mt-3",rows:"3",placeholder:"Enter reason..."}),e.jsxs(O,{children:[e.jsx(l,{variant:"outline",onClick:()=>{m(!1),y(null),x("")},children:"Cancel"}),e.jsx(l,{onClick:U,disabled:!u.trim(),className:"bg-blue-600 hover:bg-blue-700",children:"Save Change"})]})]})})]})}export{le as default};
