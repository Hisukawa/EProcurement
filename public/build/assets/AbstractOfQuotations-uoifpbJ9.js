import{a,u as M,j as e,H as me,c as S}from"./app-CKujYd7_.js";import{A as ue}from"./ApproverLayout-DHRba1lg.js";import{D as w,a as C,b as R,c as D,d as I,e as E}from"./dialog-BoAiw6q7.js";import{B as c}from"./button-BDytyKvn.js";import{T as L}from"./textarea-BMcLuW6R.js";import{u as xe}from"./use-toast-Bax0zrdw.js";import{A as he}from"./AOQTabs-COIwPlKE.js";import{L as Q}from"./label-CZ5g-yx2.js";import{I as X}from"./input-DRLIerdr.js";import"./Dropdown-CeA5lpHF.js";import"./transition-GwQ5KLRO.js";import"./toaster-BC5ooZuz.js";import"./index-BISxdjyy.js";import"./index-Boi0YpkC.js";import"./createLucideIcon-LguoqwsX.js";import"./utils-zLT5xWck.js";import"./index-DK87wXAm.js";import"./index-6toc2nnT.js";import"./XMarkIcon-CQ1f9l2a.js";import"./file-text-PtfCvhuH.js";import"./index-BRvPMNG7.js";function Qe({rfq:o,groupedDetails:F={},committee:u}){var K;const d=o.purchase_request,[$,Z]=a.useState(""),[j,b]=a.useState({open:!1,type:"success",title:"",description:""}),[ee,y]=a.useState(!1),{toast:v}=xe(),[p,se]=a.useState(null),[_,q]=a.useState(""),[x,W]=a.useState(o.award_mode??"whole-pr"),[P,te]=a.useState(()=>{const s={};return["secretariat","member1","member2","member3","vice_chair","chair"].forEach(l=>{var n,i;const r=(i=(n=u==null?void 0:u.members)==null?void 0:n.filter(h=>h.position===l))==null?void 0:i.find(h=>h.status==="active");s[l]={name:(r==null?void 0:r.name)||"",status:(r==null?void 0:r.status)||"inactive"}}),{status:(u==null?void 0:u.status)||"draft",members:s}}),[re,O]=a.useState(!1),[z,be]=a.useState(null),[V,A]=a.useState(!1),[H,T]=a.useState(!1),[ge,fe]=a.useState("as-read"),ae=()=>{T(!0);const s={remarks_as_read:$,mode:x,...x==="per-item"?{detail_id:z.detailId}:{}};S.post(route("bac_user.rollback_winner_as_read",{id:z.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{O(!1),T(!1),b({open:!0,type:"success",title:"Rollback Successful",description:"Winner selection has been rolled back."}),v({title:"Rollback Successful",description:"Winner selection has been rolled back.",duration:3e3})},onError:()=>{T(!1),b({open:!0,type:"error",title:"Rollback Failed",description:"Unable to rollback winner. Please try again."})}})},g={};d.details.forEach(s=>{(F[s.id]||[]).forEach(l=>{const r=l.supplier.id;g[r]||(g[r]={supplier:l.supplier,detailIds:new Set,total:0,quotes:[]}),g[r].detailIds.add(s.id);const n=s.quantity??1,i=parseFloat(l.quoted_price??0)||0;g[r].total+=i*n,g[r].quotes.push(l),l.is_winner_as_read})});const ne=d.details.length,f=Object.values(g).filter(s=>s.detailIds.size===ne),B=f.length>0;a.useEffect(()=>{!B&&x==="whole-pr"&&W("per-item")},[B,x]),d.details.some(s=>(F[s.id]||[]).some(t=>t.is_winner_as_read));const[ie,k]=a.useState(!1),[N,le]=a.useState(null),[Y,G]=a.useState(""),[J,U]=a.useState(!1),oe=()=>{U(!0);const s={supplier_id:N.supplierId,remarks_as_read:Y,mode:x,...N.detailId!==null?{detail_id:N.detailId}:{}};S.post(route("bac_user.save_remarks_as_read",{id:N.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{U(!1),k(!1),v({title:"Remarks Saved",description:"Supplier remarks updated successfully.",duration:3e3}),S.reload({only:["rfq","groupedDetails"]})},onError:()=>{U(!1),v({title:"Save Failed",description:"Could not save remarks. Please try again.",variant:"destructive",duration:3e3})}})},ce=(s,t)=>window.open(route("bac_user.print_aoq",{id:s,pr_detail_id:t}),"_blank");M({project_no:"",date_of_opening:"",venue:""});const m=M({project_no:o.project_no||"",date_of_opening:o.date_of_opening||"",venue:o.venue||""});a.useEffect(()=>{m.setData({project_no:o.project_no||"",date_of_opening:o.date_of_opening||"",venue:o.venue||""})},[o]);const de=s=>{s.preventDefault(),m.post(route("bac_user.submit_project_info",o.id))};return e.jsxs(ue,{children:[e.jsx(me,{title:`Abstract for ${d.pr_number}`}),e.jsxs("div",{className:"px-8 py-10",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-6",children:["Abstract of Quotations â€“ PR #",d.pr_number]}),e.jsx(he,{pr:d.id}),e.jsx("div",{className:"mb-4 flex justify-between items-center",children:e.jsx("button",{onClick:()=>window.history.back(),className:"inline-flex items-center px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-md text-sm shadow-sm",children:"â† Back"})}),e.jsx("div",{className:"mb-6 flex gap-4",children:e.jsx(c,{variant:x==="whole-pr"?"default":"outline",onClick:()=>W("whole-pr"),disabled:!!o.award_mode,children:"Winner for Entire PR"})}),!B&&e.jsx("p",{className:"text-sm text-red-600 mb-4",children:"âš ï¸ No supplier quoted for all items. You can only declare winners per item."}),e.jsx("form",{onSubmit:de,className:"mt-6 mb-4 border-t pt-6",children:e.jsxs("div",{className:"bg-white shadow-md rounded-lg p-6 space-y-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 border-b pb-3",children:"Project Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Q,{htmlFor:"project_number",className:"text-sm font-medium text-gray-700 mb-1",children:"Project Number"}),e.jsx(L,{id:"project_number",rows:6,className:"resize-none bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:m.data.project_no,onChange:s=>m.setData("project_no",s.target.value),placeholder:"Enter project number..."})]}),e.jsxs("div",{className:"flex flex-col justify-between h-full space-y-4",children:[e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"date_opening",className:"text-sm font-medium text-gray-700 mb-1",children:"Date of Opening"}),e.jsx(X,{id:"date_opening",type:"date",className:"w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:m.data.date_of_opening,onChange:s=>m.setData("date_of_opening",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"venue",className:"text-sm font-medium text-gray-700 mb-1",children:"Venue"}),e.jsx(X,{id:"venue",type:"text",className:"w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:m.data.venue,onChange:s=>m.setData("venue",s.target.value),placeholder:"Enter venue..."})]})]})]}),e.jsx("div",{className:"pt-4 border-t mt-6 flex justify-end",children:e.jsx(c,{type:"submit",disabled:m.processing,className:"px-6",children:m.processing?"Submitting...":"Submit Project Info"})})]})}),x==="whole-pr"&&e.jsxs("div",{className:"mb-10 border p-4 rounded-lg bg-white shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Comparison for Entire Purchase Request"}),e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Focal Person:"})," ",d.focal_person.firstname," ",d.focal_person.lastname]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Division:"})," ",d.division.division]})]})]}),e.jsx("button",{onClick:()=>ce(o.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md h-fit",children:"ðŸ–¨ï¸ Print Abstract as Read"})]}),e.jsxs("table",{className:"w-full text-sm border border-gray-300 rounded-lg overflow-hidden shadow",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-4 py-3 text-left font-semibold",children:"Item"}),f.map(s=>e.jsx("th",{className:"border px-4 py-3 text-center font-semibold text-xs w-56",children:s.supplier.company_name},s.supplier.id))]})}),e.jsxs("tbody",{children:[d.details.map((s,t)=>{const l=F[s.id]||[],r=l.reduce((n,i)=>!n||parseFloat(i.quoted_price)<parseFloat(n.quoted_price)?i:n,null);return e.jsxs("tr",{className:t%2===0?"bg-white":"bg-gray-50",children:[e.jsxs("td",{className:"border px-4 py-2 font-medium",children:[s.item," ",s.specs]}),f.map(n=>{const i=l.find(pe=>pe.supplier.id===n.supplier.id),h=i&&r&&i.supplier.id===r.supplier.id;return e.jsx("td",{className:`border px-4 py-2 text-center align-top ${h?"bg-green-50":""}`,children:i?e.jsxs("span",{className:`font-semibold ${h?"text-green-700":"text-gray-800"}`,children:[e.jsxs("span",{className:"mr-1",children:["â‚±",Math.round(i.quoted_price).toLocaleString()]}),e.jsx("span",{className:"mx-1",children:"x"}),e.jsx("span",{className:"mr-1",children:s.quantity}),e.jsx("span",{children:s.unit})]}):e.jsx("span",{className:"text-gray-400",children:"â€”"})},n.supplier.id)})]},s.id)}),e.jsxs("tr",{className:"bg-gray-200 font-semibold",children:[e.jsx("td",{className:"border px-4 py-3 text-right",children:"Total Quoted Price Per Unit"}),f.map(s=>e.jsxs("td",{className:"border px-4 py-3 text-right text-green-700",children:["â‚±",parseFloat(s.total).toLocaleString()]},s.supplier.id))]}),e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-3 text-right font-semibold",children:"Supplier Remarks"}),f.map(s=>{const t=s.quotes.filter(n=>n.rfq_id===o.id).map(n=>{var i;return((i=n.remarks_as_read)==null?void 0:i.trim())||""}),r=t.every((n,i,h)=>n===h[0])&&t.length>0?t[0]||"No remarks":"Varying remarks (edit to unify)";return e.jsx("td",{className:"border px-4 py-3 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-xs text-gray-600 italic",children:r}),e.jsx(c,{size:"xs",variant:"outline",className:"px-2 py-1",onClick:()=>{le({rfqId:o.id,supplierId:s.supplier.id,detailId:null,currentRemarks:r==="No remarks"||r.includes("Varying")?"":r}),G(r==="No remarks"||r.includes("Varying")?"":r),k(!0)},children:"Edit Remarks"})]})},`remarks-${s.supplier.id}`)})]})]})]})]}),e.jsxs("div",{className:"mb-8 p-4 border rounded-lg bg-gray-50 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"BAC Committee"}),e.jsx("ul",{className:"space-y-3",children:["chair","vice_chair","secretariat","member1","member2","member3"].map(s=>{const t=P.members[s];return(t==null?void 0:t.status)==="active"&&e.jsxs("li",{className:"flex items-center justify-between bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.name||"â€”"}),e.jsx("p",{className:"text-sm text-gray-500",children:s.replace("_"," ").toUpperCase()})]}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>{se({position:s,current:t}),q(""),y(!0)},children:"Replace"})]},s)})})]})]}),e.jsx(w,{open:ee,onOpenChange:y,children:e.jsxs(C,{className:"sm:max-w-md",children:[e.jsxs(R,{children:[e.jsx(D,{children:"Replace Committee Member"}),e.jsxs(I,{children:["Enter a new member to replace"," ",e.jsx("strong",{children:((K=p==null?void 0:p.current)==null?void 0:K.name)||"N/A"})," (",p==null?void 0:p.position.replace("_"," ").toUpperCase(),")."]})]}),e.jsx("input",{type:"text",value:_,onChange:s=>q(s.target.value),placeholder:"Enter new member name",className:"w-full border px-3 py-2 rounded mb-2"}),e.jsxs(E,{className:"mt-4",children:[e.jsx(c,{variant:"secondary",onClick:()=>y(!1),children:"Cancel"}),e.jsx(c,{disabled:V,onClick:()=>{if(!_.trim())return;A(!0),te(t=>({...t,members:{...t.members,[p.position]:{name:_.trim(),status:"active"}}}));const s={id:(u==null?void 0:u.id)??null,status:P.status,members:Object.entries({...P.members,[p.position]:{name:_.trim(),status:"active"}}).map(([t,l])=>({position:t,name:l.name,status:l.status}))};S.post(route("bac.committee.save"),s,{preserveScroll:!0,onSuccess:()=>{A(!1),y(!1),b({open:!0,type:"success",title:"Committee Updated",description:`${p.position.replace("_"," ")} replaced successfully.`}),v({title:"Committee Updated",description:`${p.position.replace("_"," ")} replaced successfully.`,duration:3e3})},onError:()=>{A(!1),b({open:!0,type:"error",title:"Committee Update Failed",description:"Unable to replace committee member. Please try again."})}})},children:V?"Saving...":"Confirm"})]})]})}),e.jsx(w,{open:re,onOpenChange:O,children:e.jsxs(C,{children:[e.jsxs(R,{children:[e.jsx(D,{children:"Rollback Winner"}),e.jsx(I,{children:"Provide remarks for rolling back this winner selection."})]}),e.jsx(L,{value:$,onChange:s=>Z(s.target.value)}),e.jsxs(E,{children:[e.jsx(c,{variant:"secondary",onClick:()=>O(!1),children:"Cancel"}),e.jsx(c,{disabled:H,variant:"destructive",onClick:ae,children:H?"Rolling Back Winner...":"Confirm Rollback"})]})]})}),e.jsx(w,{open:j.open,onOpenChange:s=>b(t=>({...t,open:s})),children:e.jsxs(C,{children:[e.jsxs(R,{children:[e.jsx(D,{className:j.type==="error"?"text-red-600":"text-green-600",children:j.title}),e.jsx(I,{children:j.description})]}),e.jsx(E,{children:e.jsx(c,{onClick:()=>b(s=>({...s,open:!1})),children:"Close"})})]})}),e.jsx(w,{open:ie,onOpenChange:k,children:e.jsxs(C,{children:[e.jsxs(R,{children:[e.jsx(D,{children:"Edit Supplier Remarks"}),e.jsxs(I,{children:["Enter remarks for this supplier ",x==="per-item"?"on this item":"for the PR","."]})]}),e.jsx(L,{value:Y,onChange:s=>G(s.target.value)}),e.jsxs(E,{children:[e.jsx(c,{variant:"secondary",onClick:()=>k(!1),children:"Cancel"}),e.jsx(c,{disabled:J,onClick:oe,children:J?"Saving...":"Save"})]})]})})]})}export{Qe as default};
