import{u as ie,a as N,j as e}from"./app-DqNKJLgr.js";import{u as ce}from"./use-toast-CL8hAUqx.js";import M from"./AutoCompleteInput-DvLnKU15.js";import{D as de,a as me,b as ue,c as pe,d as he,e as xe}from"./dialog-K3Udw0HJ.js";import{B as H}from"./button-CskkiS1y.js";import{F as ge}from"./file-text-DPSMfJ5_.js";import{M as be}from"./minus-DtLKptXg.js";import{S as fe}from"./send-horizontal-5lov6HBT.js";import"./index-Dl_JvOZ6.js";import"./index-4KP02Cg3.js";import"./createLucideIcon-4VTRvRLE.js";import"./utils-CV84Dt2y.js";import"./index-DiY8fTyq.js";function Ae({purchaseOrder:u,inventoryItems:b=[],user:v,ppeOptions:w=[],parNumber:Y}){var R,I,q,A,O,T;const n=((I=(R=u==null?void 0:u.detail)==null?void 0:R.pr_detail)==null?void 0:I.purchase_request)??null;n&&`${((q=n==null?void 0:n.focal_person)==null?void 0:q.firstname)??""} ${((A=n==null?void 0:n.focal_person)==null?void 0:A.middlename)??""} ${((O=n==null?void 0:n.focal_person)==null?void 0:O.lastname)??""}`.trim();const{data:r,setData:i,post:Q,processing:C,errors:S,reset:W}=ie({po_id:(u==null?void 0:u.id)??null,par_number:Y??"",requested_by:((T=n==null?void 0:n.focal_person)==null?void 0:T.id)??null,issued_by:(v==null?void 0:v.id)??null,remarks:"",date_acquired:new Date().toISOString().split("T")[0],items:b.map(t=>{var s;return{inventory_item_id:t.id,recipient:"",recipient_division:"",estimated_useful_life:null,inventory_item_number:"",ppe_sub_major_account:"",general_ledger_account:"",office:"",school:"",quantity:t.total_stock>0?1:0,unit_cost:t.unit_cost??0,total_cost:t.unit_cost??0,series_number:"0001",description:t.item_desc??((s=t.product)==null?void 0:s.item_description)??"N/A",ppe:null,gl:null,officeObj:null,schoolObj:null}})}),{toast:k}=ce(),[J,h]=N.useState(!1),[K,V]=N.useState(""),[X,Z]=N.useState(""),_=async()=>{const t=r.items.filter(s=>s.ppe&&s.gl&&s.quantity>0);if(t.length)try{const s=t[0],c=await(await fetch(`/api/ics-next-series?ppe=${encodeURIComponent(s.ppe.name.trim())}&gl=${encodeURIComponent(s.gl.name.trim())}`)).json();let d=parseInt(c.series||"0",10);const p=[...r.items];t.forEach(l=>{var F,$,E,P,z,U,B,L;const g=d.toString().padStart(4,"0"),f=new Date().getFullYear().toString(),j=((F=l.ppe.code)==null?void 0:F.padStart(2,"0"))||"00",a=(($=l.gl.code)==null?void 0:$.padStart(2,"0"))||"00",m=((P=(E=l.officeObj)==null?void 0:E.code)==null?void 0:P.padStart(2,"0"))||"",y=((z=l.officeObj)==null?void 0:z.name)==="Schools"&&((U=l.schoolObj)!=null&&U.code)?l.schoolObj.code.padStart(2,"0"):"",le=[f,j,a,g,m].filter(Boolean).concat(y?[y]:[]).join("-"),ne=p.findIndex(re=>re===l);p[ne]={...l,inventory_item_number:le,series_number:g,ppe_sub_major_account:l.ppe.name,general_ledger_account:l.gl.name,office:((B=l.officeObj)==null?void 0:B.name)||"",school:((L=l.schoolObj)==null?void 0:L.name)||""},d++}),i("items",p)}catch(s){console.error("Error generating inventory numbers",s)}},D=(t,s,o)=>{const c=[...r.items];if(s==="quantity"){const d=Math.min(parseFloat(o)||0,b[t].total_stock);c[t].quantity=d,c[t].total_cost=d*(c[t].unit_cost??0)}else c[t][s]=o;i("items",c)},G=(t,s)=>{const o=[...r.items];o[t].ppe=s,o[t].gl=null,o[t].ppe_sub_major_account=(s==null?void 0:s.name)||"",o[t].general_ledger_account="",i("items",o)},ee=(t,s)=>{const o=[...r.items];o[t].gl=s,o[t].general_ledger_account=(s==null?void 0:s.name)||"",i("items",o),_()},te=(t,s)=>{const o=[...r.items];o[t].officeObj=s,o[t].office=(s==null?void 0:s.name)||"",i("items",o),_()},se=(t,s)=>{const o=[...r.items];o[t].schoolObj=s,o[t].school=(s==null?void 0:s.name)||"",i("items",o),_()},ae=t=>{t.preventDefault(),h(!0)},oe=()=>{Q(route("supply_officer.store_par"),{preserveScroll:!0,onSuccess:()=>{k({title:"Success",description:"PAR has been saved successfully!",className:"bg-green-600 text-white",duration:3e3}),h(!1),W()},onError:()=>{k({variant:"destructive",title:"Error",description:"Failed to save PAR. Please check the form."}),h(!1)}})},x=b.some(t=>t.source_type==="central");return e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[e.jsxs("h2",{className:"text-3xl font-bold text-blue-800 mb-4 flex items-center gap-2",children:[e.jsx(ge,{size:24})," Property Acknowledgement Receipt (PAR)"]}),Object.keys(S).length>0&&e.jsx("div",{className:"bg-red-100 text-red-700 p-4 rounded mb-4",children:e.jsx("ul",{className:"list-disc list-inside",children:Object.entries(S).map(([t,s])=>e.jsx("li",{children:s},t))})}),e.jsxs("form",{onSubmit:ae,className:"space-y-6",children:[r.items.map((t,s)=>{var o,c,d,p,l,g,f,j;return e.jsxs("div",{className:"p-5 border rounded-md bg-green-50 relative",children:[r.items.length>1&&e.jsx("button",{type:"button",onClick:()=>i("items",r.items.filter((a,m)=>m!==s)),className:"absolute top-2 right-2 text-red-600 hover:text-red-800",children:e.jsx(be,{size:20})}),e.jsxs("h3",{className:"text-lg font-semibold text-green-700 mb-4",children:["Item ",s+1]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Description"}),e.jsx("input",{value:t.description,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"PPE Sub-major Account"}),e.jsxs("select",{value:((o=t.ppe)==null?void 0:o.id)||"",onChange:a=>G(s,w.find(m=>m.id==a.target.value)),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",children:[e.jsx("option",{value:"",children:"Select PPE"}),w.map(a=>e.jsx("option",{value:a.id,children:a.code?`${a.code} - ${a.name}`:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"General Ledger Account"}),e.jsxs("select",{value:((c=t.gl)==null?void 0:c.id)||"",onChange:a=>{var m;return ee(s,(m=t.ppe)==null?void 0:m.general_ledger_accounts.find(y=>y.id==a.target.value))},disabled:!t.ppe,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select GL"}),(p=(d=t.ppe)==null?void 0:d.general_ledger_accounts)==null?void 0:p.map(a=>e.jsx("option",{value:a.id,children:a.code?`${a.code} - ${a.name}`:a.name},a.id))]})]}),e.jsx(M,{label:"Location Office",apiRoute:"/api/office-search",value:((l=t.officeObj)==null?void 0:l.code)||"",onChange:a=>te(s,a),placeholder:"Type Location Office..."}),((g=t.officeObj)==null?void 0:g.name)==="Schools"&&e.jsx(M,{label:"School",apiRoute:"/api/school-search",value:((f=t.schoolObj)==null?void 0:f.name)||"",onChange:a=>se(s,a),placeholder:"Type School..."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Inventory Item No."}),e.jsx("input",{value:t.inventory_item_number||"",readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-100"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Quantity"}),e.jsx("input",{type:"number",min:"1",max:(j=b[s])==null?void 0:j.total_stock,value:t.quantity,onChange:a=>D(s,"quantity",a.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Unit Cost"}),e.jsx("input",{type:"number",value:t.unit_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Total Cost"}),e.jsx("input",{type:"number",value:t.total_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Estimated Useful Life (years)"}),e.jsx("input",{type:"number",value:t.estimated_useful_life??"",onChange:a=>D(s,"estimated_useful_life",a.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",onWheel:a=>a.currentTarget.blur(),required:!0})]})]},s)}),e.jsxs("div",{className:"p-5 border rounded-md bg-yellow-50",children:[e.jsxs("h3",{className:"text-lg font-semibold text-yellow-700 mb-4",children:["Default Recipient (applied to all items)",x&&e.jsx("span",{className:"text-red-600 ml-2 text-sm font-normal",children:"* Required for CENTRAL sourced items"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Recipient Name ",x&&e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"text",value:K,onChange:t=>{V(t.target.value),i("items",r.items.map(s=>({...s,recipient:t.target.value})))},placeholder:"Leave blank to issue to requester",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",required:x})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Recipient Division ",x&&e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"text",value:X,onChange:t=>{Z(t.target.value),i("items",r.items.map(s=>({...s,recipient_division:t.target.value})))},placeholder:"Optional",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",required:x})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remarks"}),e.jsx("textarea",{value:r.remarks,onChange:t=>i("remarks",t.target.value),rows:"4",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",placeholder:"Optional"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"submit",className:"inline-flex items-center px-6 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800",disabled:C,children:[e.jsx(fe,{size:16,className:"mr-2"})," ",C?"Saving...":"Save PAR"]})})]}),e.jsx(de,{open:J,onOpenChange:h,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsxs(ue,{children:[e.jsx(pe,{children:"Confirm Save"}),e.jsx(he,{children:"Are you sure you want to save this PAR issuance?"})]}),e.jsxs(xe,{className:"mt-4 flex justify-end gap-2",children:[e.jsx(H,{variant:"secondary",onClick:()=>h(!1),children:"Cancel"}),e.jsx(H,{onClick:oe,children:"Yes, Save PAR"})]})]})})]})}export{Ae as default};
