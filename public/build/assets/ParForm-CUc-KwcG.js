import{u as re,a as _,j as e}from"./app-duXzzImO.js";import{u as ie}from"./use-toast-D7hdoR5h.js";import M from"./AutoCompleteInput-Ddc7CX0p.js";import{D as ce,a as de,b as me,c as ue,d as pe,e as he}from"./dialog-DS-DoP21.js";import{B as H}from"./button-D0lWBgCo.js";import{F as xe}from"./file-text-CrQxbWaj.js";import{M as ge}from"./minus-DSm_5CkB.js";import{S as be}from"./send-horizontal-DHZttDD3.js";import"./index-3jnUzLIS.js";import"./index-CSqca6Ux.js";import"./createLucideIcon-CoZQ0qwL.js";import"./utils-C5BPRwjQ.js";import"./index-CoOSbRev.js";function Ae({purchaseOrder:u,inventoryItems:j=[],user:y,ppeOptions:N=[],parNumber:L}){var D,I,R,A,O,q;const n=((I=(D=u==null?void 0:u.detail)==null?void 0:D.pr_detail)==null?void 0:I.purchase_request)??null;n&&`${((R=n==null?void 0:n.focal_person)==null?void 0:R.firstname)??""} ${((A=n==null?void 0:n.focal_person)==null?void 0:A.middlename)??""} ${((O=n==null?void 0:n.focal_person)==null?void 0:O.lastname)??""}`.trim();const{data:r,setData:i,post:Y,processing:w,errors:C,reset:Q}=re({po_id:(u==null?void 0:u.id)??null,par_number:L??"",requested_by:((q=n==null?void 0:n.focal_person)==null?void 0:q.id)??null,issued_by:(y==null?void 0:y.id)??null,remarks:"",date_acquired:new Date().toISOString().split("T")[0],items:j.map(t=>{var s;return{inventory_item_id:t.id,recipient:"",recipient_division:"",estimated_useful_life:null,inventory_item_number:"",ppe_sub_major_account:"",general_ledger_account:"",office:"",school:"",quantity:t.total_stock>0?1:0,unit_cost:t.unit_cost??0,total_cost:t.unit_cost??0,series_number:"0001",description:t.item_desc??((s=t.product)==null?void 0:s.item_description)??"N/A",ppe:null,gl:null,officeObj:null,schoolObj:null}})}),{toast:S}=ie(),[W,h]=_.useState(!1),[J,K]=_.useState(""),[V,X]=_.useState(""),v=async()=>{const t=r.items.filter(s=>s.ppe&&s.gl&&s.quantity>0);if(t.length)try{const s=t[0],c=await(await fetch(`/api/ics-next-series?ppe=${encodeURIComponent(s.ppe.name.trim())}&gl=${encodeURIComponent(s.gl.name.trim())}`)).json();let d=parseInt(c.series||"0",10);const p=[...r.items];t.forEach(l=>{var F,T,$,E,P,z,U,B;const x=d.toString().padStart(4,"0"),g=new Date().getFullYear().toString(),b=((F=l.ppe.code)==null?void 0:F.padStart(2,"0"))||"00",a=((T=l.gl.code)==null?void 0:T.padStart(2,"0"))||"00",m=((E=($=l.officeObj)==null?void 0:$.code)==null?void 0:E.padStart(2,"0"))||"",f=((P=l.officeObj)==null?void 0:P.name)==="Schools"&&((z=l.schoolObj)!=null&&z.code)?l.schoolObj.code.padStart(2,"0"):"",oe=[g,b,a,x,m].filter(Boolean).concat(f?[f]:[]).join("-"),le=p.findIndex(ne=>ne===l);p[le]={...l,inventory_item_number:oe,series_number:x,ppe_sub_major_account:l.ppe.name,general_ledger_account:l.gl.name,office:((U=l.officeObj)==null?void 0:U.name)||"",school:((B=l.schoolObj)==null?void 0:B.name)||""},d++}),i("items",p)}catch(s){console.error("Error generating inventory numbers",s)}},k=(t,s,o)=>{const c=[...r.items];if(s==="quantity"){const d=Math.min(parseFloat(o)||0,j[t].total_stock);c[t].quantity=d,c[t].total_cost=d*(c[t].unit_cost??0)}else c[t][s]=o;i("items",c)},Z=(t,s)=>{const o=[...r.items];o[t].ppe=s,o[t].gl=null,o[t].ppe_sub_major_account=(s==null?void 0:s.name)||"",o[t].general_ledger_account="",i("items",o)},G=(t,s)=>{const o=[...r.items];o[t].gl=s,o[t].general_ledger_account=(s==null?void 0:s.name)||"",i("items",o),v()},ee=(t,s)=>{const o=[...r.items];o[t].officeObj=s,o[t].office=(s==null?void 0:s.name)||"",i("items",o),v()},te=(t,s)=>{const o=[...r.items];o[t].schoolObj=s,o[t].school=(s==null?void 0:s.name)||"",i("items",o),v()},se=t=>{t.preventDefault(),h(!0)},ae=()=>{Y(route("supply_officer.store_par"),{preserveScroll:!0,onSuccess:()=>{S({title:"Success",description:"PAR has been saved successfully!",className:"bg-green-600 text-white",duration:3e3}),h(!1),Q()},onError:()=>{S({variant:"destructive",title:"Error",description:"Failed to save PAR. Please check the form."}),h(!1)}})};return e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[e.jsxs("h2",{className:"text-3xl font-bold text-blue-800 mb-4 flex items-center gap-2",children:[e.jsx(xe,{size:24})," Property Acknowledgement Receipt (PAR)"]}),Object.keys(C).length>0&&e.jsx("div",{className:"bg-red-100 text-red-700 p-4 rounded mb-4",children:e.jsx("ul",{className:"list-disc list-inside",children:Object.entries(C).map(([t,s])=>e.jsx("li",{children:s},t))})}),e.jsxs("form",{onSubmit:se,className:"space-y-6",children:[r.items.map((t,s)=>{var o,c,d,p,l,x,g,b;return e.jsxs("div",{className:"p-5 border rounded-md bg-green-50 relative",children:[r.items.length>1&&e.jsx("button",{type:"button",onClick:()=>i("items",r.items.filter((a,m)=>m!==s)),className:"absolute top-2 right-2 text-red-600 hover:text-red-800",children:e.jsx(ge,{size:20})}),e.jsxs("h3",{className:"text-lg font-semibold text-green-700 mb-4",children:["Item ",s+1]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Description"}),e.jsx("input",{value:t.description,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-white"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"PPE Sub-major Account"}),e.jsxs("select",{value:((o=t.ppe)==null?void 0:o.id)||"",onChange:a=>Z(s,N.find(m=>m.id==a.target.value)),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",children:[e.jsx("option",{value:"",children:"Select PPE"}),N.map(a=>e.jsx("option",{value:a.id,children:a.code?`${a.code} - ${a.name}`:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"General Ledger Account"}),e.jsxs("select",{value:((c=t.gl)==null?void 0:c.id)||"",onChange:a=>{var m;return G(s,(m=t.ppe)==null?void 0:m.general_ledger_accounts.find(f=>f.id==a.target.value))},disabled:!t.ppe,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select GL"}),(p=(d=t.ppe)==null?void 0:d.general_ledger_accounts)==null?void 0:p.map(a=>e.jsx("option",{value:a.id,children:a.code?`${a.code} - ${a.name}`:a.name},a.id))]})]}),e.jsx(M,{label:"Location Office",apiRoute:"/api/office-search",value:((l=t.officeObj)==null?void 0:l.code)||"",onChange:a=>ee(s,a),placeholder:"Type Location Office..."}),((x=t.officeObj)==null?void 0:x.name)==="Schools"&&e.jsx(M,{label:"School",apiRoute:"/api/school-search",value:((g=t.schoolObj)==null?void 0:g.name)||"",onChange:a=>te(s,a),placeholder:"Type School..."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Inventory Item No."}),e.jsx("input",{value:t.inventory_item_number||"",readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-100"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Quantity"}),e.jsx("input",{type:"number",min:"1",max:(b=j[s])==null?void 0:b.total_stock,value:t.quantity,onChange:a=>k(s,"quantity",a.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Unit Cost"}),e.jsx("input",{type:"number",value:t.unit_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Total Cost"}),e.jsx("input",{type:"number",value:t.total_cost,readOnly:!0,className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm bg-gray-50"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Estimated Useful Life (years)"}),e.jsx("input",{type:"number",value:t.estimated_useful_life??"",onChange:a=>k(s,"estimated_useful_life",a.target.value),className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",onWheel:a=>a.currentTarget.blur()})]})]},s)}),e.jsxs("div",{className:"p-5 border rounded-md bg-yellow-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-yellow-700 mb-4",children:"Default Recipient (applied to all items)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Recipient Name"}),e.jsx("input",{type:"text",value:J,onChange:t=>{K(t.target.value),i("items",r.items.map(s=>({...s,recipient:t.target.value})))},placeholder:"Leave blank to issue to requester",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Recipient Division"}),e.jsx("input",{type:"text",value:V,onChange:t=>{X(t.target.value),i("items",r.items.map(s=>({...s,recipient_division:t.target.value})))},placeholder:"Optional",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remarks"}),e.jsx("textarea",{value:r.remarks,onChange:t=>i("remarks",t.target.value),rows:"4",className:"w-full mt-1 px-3 py-2 border rounded-md shadow-sm",placeholder:"Optional"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"submit",className:"inline-flex items-center px-6 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800",disabled:w,children:[e.jsx(be,{size:16,className:"mr-2"})," ",w?"Saving...":"Save PAR"]})})]}),e.jsx(ce,{open:W,onOpenChange:h,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Confirm Save"}),e.jsx(pe,{children:"Are you sure you want to save this PAR issuance?"})]}),e.jsxs(he,{className:"mt-4 flex justify-end gap-2",children:[e.jsx(H,{variant:"secondary",onClick:()=>h(!1),children:"Cancel"}),e.jsx(H,{onClick:ae,children:"Yes, Save PAR"})]})]})})]})}export{Ae as default};
