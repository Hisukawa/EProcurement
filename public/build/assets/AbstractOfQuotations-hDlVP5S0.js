import{a as i,j as e,H as ne,c as _}from"./app-CtTXRvSW.js";import{A as oe}from"./ApproverLayout-Da9_YcrQ.js";import{D as S,a as w,b as C,c as R,d as D,e as I}from"./dialog-Bx8Sq_PR.js";import{B as d}from"./button-BXv_ZNaU.js";import{T as G}from"./textarea-BLqbs9Wn.js";import{u as ce}from"./use-toast-n7ss-q37.js";import{A as de}from"./AOQTabs-DtzlQZDL.js";import"./Dropdown-BOTfWPms.js";import"./transition-CwMeo9Sp.js";import"./toaster-BHX75O9a.js";import"./index-Bhk03iWx.js";import"./index-Dow8KyZk.js";import"./createLucideIcon-BS5JQiMA.js";import"./utils-_QWm-tM-.js";import"./index-ClPfL8xw.js";import"./index-BrVwGuKN.js";import"./XMarkIcon-B3-C-RCN.js";import"./file-text-CFdLJT4B.js";import"./index-B2vGw--Q.js";function Oe({rfq:x,groupedDetails:E={},committee:p}){var Y;const o=x.purchase_request,[B,J]=i.useState(""),[j,h]=i.useState({open:!1,type:"success",title:"",description:""}),[K,f]=i.useState(!1),{toast:k}=ce(),[c,M]=i.useState(null),[y,U]=i.useState(""),[m,Q]=i.useState(x.award_mode??"whole-pr"),[A,X]=i.useState(()=>{const s={};return["secretariat","member1","member2","member3","vice_chair","chair"].forEach(n=>{var a,l;const r=(l=(a=p==null?void 0:p.members)==null?void 0:a.filter(u=>u.position===n))==null?void 0:l.find(u=>u.status==="active");s[n]={name:(r==null?void 0:r.name)||"",status:(r==null?void 0:r.status)||"inactive"}}),{status:(p==null?void 0:p.status)||"draft",members:s}}),[Z,O]=i.useState(!1),[$,pe]=i.useState(null),[W,q]=i.useState(!1),[L,P]=i.useState(!1),[me,ue]=i.useState("as-read"),ee=()=>{P(!0);const s={remarks_as_read:B,mode:m,...m==="per-item"?{detail_id:$.detailId}:{}};_.post(route("bac_user.rollback_winner_as_read",{id:$.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{O(!1),P(!1),h({open:!0,type:"success",title:"Rollback Successful",description:"Winner selection has been rolled back."}),k({title:"Rollback Successful",description:"Winner selection has been rolled back.",duration:3e3})},onError:()=>{P(!1),h({open:!0,type:"error",title:"Rollback Failed",description:"Unable to rollback winner. Please try again."})}})},b={};o.details.forEach(s=>{(E[s.id]||[]).forEach(n=>{const r=n.supplier.id;b[r]||(b[r]={supplier:n.supplier,detailIds:new Set,total:0,quotes:[]}),b[r].detailIds.add(s.id);const a=s.quantity??1,l=parseFloat(n.quoted_price??0)||0;b[r].total+=l*a,b[r].quotes.push(n),n.is_winner_as_read})});const se=o.details.length,g=Object.values(b).filter(s=>s.detailIds.size===se),F=g.length>0;i.useEffect(()=>{!F&&m==="whole-pr"&&Q("per-item")},[F,m]),o.details.some(s=>(E[s.id]||[]).some(t=>t.is_winner_as_read));const[te,v]=i.useState(!1),[N,re]=i.useState(null),[z,H]=i.useState(""),[V,T]=i.useState(!1),ae=()=>{T(!0);const s={supplier_id:N.supplierId,remarks_as_read:z,mode:m,...N.detailId!==null?{detail_id:N.detailId}:{}};_.post(route("bac_user.save_remarks_as_read",{id:N.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{T(!1),v(!1),k({title:"Remarks Saved",description:"Supplier remarks updated successfully.",duration:3e3}),_.reload({only:["rfq","groupedDetails"]})},onError:()=>{T(!1),k({title:"Save Failed",description:"Could not save remarks. Please try again.",variant:"destructive",duration:3e3})}})},ie=(s,t)=>window.open(route("bac_user.print_aoq",{id:s,pr_detail_id:t}),"_blank");return e.jsxs(oe,{children:[e.jsx(ne,{title:`Abstract for ${o.pr_number}`}),e.jsxs("div",{className:"px-8 py-10",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-6",children:["Abstract of Quotations â€“ PR #",o.pr_number]}),e.jsx(de,{pr:o.id}),e.jsx("div",{className:"mb-4 flex justify-between items-center",children:e.jsx("button",{onClick:()=>window.history.back(),className:"inline-flex items-center px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-md text-sm shadow-sm",children:"â† Back"})}),e.jsx("div",{className:"mb-6 flex gap-4",children:e.jsx(d,{variant:m==="whole-pr"?"default":"outline",onClick:()=>Q("whole-pr"),disabled:!!x.award_mode,children:"Winner for Entire PR"})}),!F&&e.jsx("p",{className:"text-sm text-red-600 mb-4",children:"âš ï¸ No supplier quoted for all items. You can only declare winners per item."}),m==="whole-pr"&&e.jsxs("div",{className:"mb-10 border p-4 rounded-lg bg-white shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Comparison for Entire Purchase Request"}),e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Focal Person:"})," ",o.focal_person.firstname," ",o.focal_person.lastname]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Division:"})," ",o.division.division]})]})]}),e.jsx("button",{onClick:()=>ie(x.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md h-fit",children:"ðŸ–¨ï¸ Print Abstract as Read"})]}),e.jsxs("table",{className:"w-full text-sm border border-gray-300 rounded-lg overflow-hidden shadow",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-4 py-3 text-left font-semibold",children:"Item"}),g.map(s=>e.jsx("th",{className:"border px-4 py-3 text-center font-semibold text-xs w-56",children:s.supplier.company_name},s.supplier.id))]})}),e.jsxs("tbody",{children:[o.details.map((s,t)=>{const n=E[s.id]||[],r=n.reduce((a,l)=>!a||parseFloat(l.quoted_price)<parseFloat(a.quoted_price)?l:a,null);return e.jsxs("tr",{className:t%2===0?"bg-white":"bg-gray-50",children:[e.jsxs("td",{className:"border px-4 py-2 font-medium",children:[s.item," ",s.specs]}),g.map(a=>{const l=n.find(le=>le.supplier.id===a.supplier.id),u=l&&r&&l.supplier.id===r.supplier.id;return e.jsx("td",{className:`border px-4 py-2 text-center align-top ${u?"bg-green-50":""}`,children:l?e.jsxs("span",{className:`font-semibold ${u?"text-green-700":"text-gray-800"}`,children:[e.jsxs("span",{className:"mr-1",children:["â‚±",Math.round(l.quoted_price).toLocaleString()]}),e.jsx("span",{className:"mx-1",children:"x"}),e.jsx("span",{className:"mr-1",children:s.quantity}),e.jsx("span",{children:s.unit})]}):e.jsx("span",{className:"text-gray-400",children:"â€”"})},a.supplier.id)})]},s.id)}),e.jsxs("tr",{className:"bg-gray-200 font-semibold",children:[e.jsx("td",{className:"border px-4 py-3 text-right",children:"Total Quoted Price Per Unit"}),g.map(s=>e.jsxs("td",{className:"border px-4 py-3 text-right text-green-700",children:["â‚±",parseFloat(s.total).toLocaleString()]},s.supplier.id))]}),e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("td",{className:"border px-4 py-3 text-right font-semibold",children:"Supplier Remarks"}),g.map(s=>{const t=s.quotes.filter(a=>a.rfq_id===x.id).map(a=>{var l;return((l=a.remarks_as_read)==null?void 0:l.trim())||""}),r=t.every((a,l,u)=>a===u[0])&&t.length>0?t[0]||"No remarks":"Varying remarks (edit to unify)";return e.jsx("td",{className:"border px-4 py-3 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-xs text-gray-600 italic",children:r}),e.jsx(d,{size:"xs",variant:"outline",className:"px-2 py-1",onClick:()=>{re({rfqId:x.id,supplierId:s.supplier.id,detailId:null,currentRemarks:r==="No remarks"||r.includes("Varying")?"":r}),H(r==="No remarks"||r.includes("Varying")?"":r),v(!0)},children:"Edit Remarks"})]})},`remarks-${s.supplier.id}`)})]})]})]})]}),e.jsxs("div",{className:"mb-8 p-4 border rounded-lg bg-gray-50 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"BAC Committee"}),e.jsx("ul",{className:"space-y-3",children:["chair","vice_chair","secretariat","member1","member2","member3"].map(s=>{const t=A.members[s];return(t==null?void 0:t.status)==="active"&&e.jsxs("li",{className:"flex items-center justify-between bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.name||"â€”"}),e.jsx("p",{className:"text-sm text-gray-500",children:s.replace("_"," ").toUpperCase()})]}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{M({position:s,current:t}),U(""),f(!0)},children:"Replace"})]},s)})})]})]}),e.jsx(S,{open:K,onOpenChange:f,children:e.jsxs(w,{className:"sm:max-w-md",children:[e.jsxs(C,{children:[e.jsx(R,{children:"Replace Committee Member"}),e.jsxs(D,{children:["Enter a new member to replace"," ",e.jsx("strong",{children:((Y=c==null?void 0:c.current)==null?void 0:Y.name)||"N/A"})," (",c==null?void 0:c.position.replace("_"," ").toUpperCase(),")."]})]}),e.jsx("input",{type:"text",value:y,onChange:s=>U(s.target.value),placeholder:"Enter new member name",className:"w-full border px-3 py-2 rounded mb-2"}),e.jsxs(I,{className:"mt-4",children:[e.jsx(d,{variant:"secondary",onClick:()=>f(!1),children:"Cancel"}),e.jsx(d,{disabled:W,onClick:()=>{if(!y.trim())return;q(!0),X(t=>({...t,members:{...t.members,[c.position]:{name:y.trim(),status:"active"}}}));const s={id:(p==null?void 0:p.id)??null,status:A.status,members:Object.entries({...A.members,[c.position]:{name:y.trim(),status:"active"}}).map(([t,n])=>({position:t,name:n.name,status:n.status}))};_.post(route("bac.committee.save"),s,{preserveScroll:!0,onSuccess:()=>{q(!1),f(!1),h({open:!0,type:"success",title:"Committee Updated",description:`${c.position.replace("_"," ")} replaced successfully.`}),k({title:"Committee Updated",description:`${c.position.replace("_"," ")} replaced successfully.`,duration:3e3})},onError:()=>{q(!1),h({open:!0,type:"error",title:"Committee Update Failed",description:"Unable to replace committee member. Please try again."})}})},children:W?"Saving...":"Confirm"})]})]})}),e.jsx(S,{open:Z,onOpenChange:O,children:e.jsxs(w,{children:[e.jsxs(C,{children:[e.jsx(R,{children:"Rollback Winner"}),e.jsx(D,{children:"Provide remarks for rolling back this winner selection."})]}),e.jsx(G,{value:B,onChange:s=>J(s.target.value)}),e.jsxs(I,{children:[e.jsx(d,{variant:"secondary",onClick:()=>O(!1),children:"Cancel"}),e.jsx(d,{disabled:L,variant:"destructive",onClick:ee,children:L?"Rolling Back Winner...":"Confirm Rollback"})]})]})}),e.jsx(S,{open:j.open,onOpenChange:s=>h(t=>({...t,open:s})),children:e.jsxs(w,{children:[e.jsxs(C,{children:[e.jsx(R,{className:j.type==="error"?"text-red-600":"text-green-600",children:j.title}),e.jsx(D,{children:j.description})]}),e.jsx(I,{children:e.jsx(d,{onClick:()=>h(s=>({...s,open:!1})),children:"Close"})})]})}),e.jsx(S,{open:te,onOpenChange:v,children:e.jsxs(w,{children:[e.jsxs(C,{children:[e.jsx(R,{children:"Edit Supplier Remarks"}),e.jsxs(D,{children:["Enter remarks for this supplier ",m==="per-item"?"on this item":"for the PR","."]})]}),e.jsx(G,{value:z,onChange:s=>H(s.target.value)}),e.jsxs(I,{children:[e.jsx(d,{variant:"secondary",onClick:()=>v(!1),children:"Cancel"}),e.jsx(d,{disabled:V,onClick:ae,children:V?"Saving...":"Save"})]})]})})]})}export{Oe as default};
