import{a as m,j as e,H as he,R as ye,L as ge,c as K}from"./app-CJGPeEqL.js";import{I as be}from"./IssuanceTabs-BL5adN0Q.js";import{S as fe}from"./SupplyOfficerLayout-CrlJ43ok.js";import{B as _}from"./button-CV5IcRIt.js";import{D as X,a as Z,b as ee,c as te,d as se,e as ae}from"./dialog-CXTlGLpV.js";import{P as Ne}from"./printer-check-wDSjpFrE.js";import{C as je}from"./circle-minus-CfJVp1z5.js";import{C as we}from"./circle-plus-BAFo7dtn.js";import{F as ve}from"./file-text-C_7YLipx.js";import"./Dropdown-CRlSc8Sf.js";import"./transition-5zZZNu15.js";import"./toaster-C6XIs2kB.js";import"./use-toast-DrlOWvM6.js";import"./index-Bj-Hhsn1.js";import"./index-nvqwRDlH.js";import"./createLucideIcon-Dy789CsD.js";import"./utils-Bli2D0HZ.js";import"./index-CpXPFYAN.js";import"./XMarkIcon-CwdTtRA1.js";import"./clipboard-check-B0tr7SMJ.js";import"./package-check-FNACoI6f.js";import"./trash-BsTuDtRD.js";import"./index-DfLKD-Dz.js";function Ve({purchaseOrders:_e,inventoryItems:re,ris:u,user:Se}){var J,B,U;const[f,le]=m.useState(""),[S,ne]=m.useState(""),[C,ie]=m.useState(new Date().getFullYear()),[oe,ce]=m.useState([]),de=t=>{ce(r=>r.includes(t)?r.filter(a=>a!==t):[...r,t])};new Map(re.map(t=>{var r;return[`${t.item_desc}_${(r=t.inventory)==null?void 0:r.unit}`,t.inventory]}));const A=new Map;(J=u==null?void 0:u.data)==null||J.forEach(t=>{const r=`${t.po_id}_${t.inventory_item_id}`;A.has(r)||A.set(r,[]),A.get(r).push(t)});const H=((B=u==null?void 0:u.data)==null?void 0:B.filter(t=>{var x,b,p,j,y,w,I,q,P,k,L,F,T,G,V;const r=((x=t.ris_number)==null?void 0:x.toLowerCase())??"",a=((b=t.requested_by)==null?void 0:b.firstname)??((p=t.issued_to)==null?void 0:p.firstname)??"",i=((j=t.requested_by)==null?void 0:j.lastname)??((y=t.issued_to)==null?void 0:y.lastname)??"",s=`${a} ${i}`.trim().toLowerCase(),d=((F=(L=(k=(P=(q=(I=(w=t.po)==null?void 0:w.details)==null?void 0:I[0])==null?void 0:q.pr_detail)==null?void 0:P.purchase_request)==null?void 0:k.division)==null?void 0:L.division)==null?void 0:F.toLowerCase())??"",l=(T=t.items)==null?void 0:T.map(pe=>{var W;return((W=pe.inventory_item)==null?void 0:W.item_desc)??""}).join(" ").toLowerCase(),c=r.includes(f.toLowerCase())||s.includes(f.toLowerCase())||d.includes(f.toLowerCase())||l.includes(f.toLowerCase()),n=(V=(G=t.items)==null?void 0:G[0])!=null&&V.created_at?new Date(t.items[0].created_at):null,o=S?n&&n.getMonth()+1===parseInt(S):!0,h=C?n&&n.getFullYear()===parseInt(C):!0;return c&&o&&h}))||[],[me,D]=m.useState(!1),[N,E]=m.useState(null),[v,R]=m.useState([]),[g,M]=m.useState(""),ue=(t,r)=>{const a=t.target.value;if(t.target.value="",a==="return"){E(r),R([]),M(""),D(!0);return}if(a==="reissuance"||a==="disposal"){const i=a==="reissuance"?"supply_officer.reissuance_form":"supply_officer.disposal_form";window.location.href=route(i,{id:r.id,type:"ris"})}},[xe,O]=m.useState(!1),[$,Y]=m.useState([]),[Q,z]=m.useState(null);return e.jsxs(fe,{header:"Schools Divisions Office - Ilagan | Requisition and Issue Slip",children:[e.jsx(he,{title:"RIS"}),e.jsx(be,{}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"Requisition and Issue Slip (RIS)"}),e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:e.jsx("button",{onClick:()=>{const t=new URLSearchParams;S&&t.append("month",S),C&&t.append("year",C),f&&t.append("search",f),window.location.href=route("supply_officer.generate_report")+"?"+t.toString()},className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm shadow",children:"Generate Report"})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Month:"}),e.jsxs("select",{className:"border border-gray-300 rounded-md px-7 py-1 text-sm",value:S,onChange:t=>ne(t.target.value),children:[e.jsx("option",{value:"",children:"All"}),["January","February","March","April","May","June","July","August","September","October","November","December"].map((t,r)=>e.jsx("option",{value:r+1,children:t},r))]}),e.jsx("label",{className:"text-sm font-medium ml-4",children:"Year:"}),e.jsx("input",{type:"number",className:"border border-gray-300 rounded-md px-2 py-1 w-20 text-sm",value:C,onChange:t=>ie(t.target.value)})]}),e.jsx("div",{children:e.jsx("input",{type:"text",placeholder:"Search Focal Person, RIS number...",className:"border border-gray-300 rounded-md px-3 py-2 w-full md:w-64 text-sm",value:f,onChange:t=>le(t.target.value)})})]}),e.jsx("div",{className:"overflow-x-auto mt-6 rounded-lg shadow-sm border border-gray-200",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm text-left text-gray-700",children:[e.jsx("thead",{className:"bg-gray-100 text-xs font-semibold uppercase tracking-wider text-gray-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:"#"}),e.jsx("th",{className:"px-4 py-3",children:"RIS No."}),e.jsx("th",{className:"px-4 py-3",children:"Division"}),e.jsx("th",{className:"px-4 py-3",children:"Issued To / Focal Person"}),e.jsx("th",{className:"px-4 py-3",children:"Item Description"}),e.jsx("th",{className:"px-4 py-3 text-center",children:"Quantity"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Unit Cost"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Total Cost"}),e.jsx("th",{className:"px-4 py-3",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-center",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:H&&H.length>0?H.map((t,r)=>{var d;const a=((d=t.items)==null?void 0:d.map(l=>{var c,n,o;return{description:((c=l.inventory_item)==null?void 0:c.item_desc)??"N/A",quantity:l.quantity,unitCost:Number(((n=l.inventory_item)==null?void 0:n.unit_cost)??0),totalCost:Number(((o=l.inventory_item)==null?void 0:o.unit_cost)??0)*l.quantity,date:new Date(l.created_at).toLocaleDateString("en-PH",{year:"numeric",month:"long",day:"numeric"})}}))||[],i=oe.includes(t.id),s=i?a:a.slice(0,1);return e.jsx(ye.Fragment,{children:s.map((l,c)=>{var n,o,h,x,b,p,j,y;return e.jsxs("tr",{className:`transition-all duration-150 ${c%2===0?"bg-white":"bg-gray-50"} hover:bg-blue-50 hover:shadow-sm`,children:[c===0&&e.jsxs(e.Fragment,{children:[e.jsx("td",{rowSpan:s.length,className:"px-4 py-3 font-semibold text-gray-800 align-top",children:r+1}),e.jsx("td",{rowSpan:s.length,className:"px-4 py-3 text-blue-600 font-medium align-top",children:t.ris_number}),e.jsx("td",{rowSpan:s.length,className:"px-4 py-3 align-top",children:((p=(b=(x=(h=(o=(n=t.po)==null?void 0:n.details)==null?void 0:o[0])==null?void 0:h.pr_detail)==null?void 0:x.purchase_request)==null?void 0:b.division)==null?void 0:p.division)??"N/A"}),e.jsxs("td",{rowSpan:s.length,className:"px-4 py-3 align-top",children:[(j=t.requested_by)==null?void 0:j.firstname," ",(y=t.requested_by)==null?void 0:y.lastname]})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"font-medium",children:l.description})}),e.jsx("td",{className:"px-4 py-3 text-center text-gray-800",children:l.quantity}),e.jsxs("td",{className:"px-4 py-3 text-right",children:["₱",l.unitCost.toFixed(2)]}),e.jsxs("td",{className:"px-4 py-3 text-right",children:["₱",l.totalCost.toFixed(2)]}),e.jsx("td",{className:"px-4 py-3",children:l.date}),c===s.length-1&&e.jsxs("td",{rowSpan:s.length,className:"px-4 py-3 text-center align-top",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 justify-center",children:[e.jsxs("a",{href:route("supply_officer.print_ris",t.id),target:"_blank",className:"inline-flex items-center justify-center gap-1 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg shadow-sm text-xs font-medium",children:[e.jsx(Ne,{size:14}),"Print"]}),e.jsx(_,{type:"button",className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-xs font-medium shadow-sm",onClick:()=>{z(t),Y([]),O(!0)},children:"Switch Type"}),e.jsx(_,{type:"button",onClick:w=>ue(w,t),value:"return",className:"bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium shadow-sm",children:"Return"})]}),a.length>2&&e.jsx("button",{onClick:()=>de(t.id),className:"mt-2 text-blue-600 hover:underline text-xs flex items-center justify-center gap-1",children:i?e.jsxs(e.Fragment,{children:[e.jsx(je,{size:14})," Show Less"]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{size:14})," Show More"]})})]})]},`${t.id}-${c}`)})},t.id)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"10",className:"text-center py-10 text-gray-500 bg-gray-50 italic",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(ve,{className:"w-10 h-10 mb-2 text-gray-400"}),e.jsx("span",{children:"No RIS records found"})]})})})})]})}),((U=u==null?void 0:u.links)==null?void 0:U.length)>3&&e.jsx("nav",{className:"mt-4 flex justify-center items-center space-x-2",children:u.links.map((t,r)=>e.jsx(ge,{href:t.url||"#",className:`
                  px-3 py-1 text-sm rounded-md
                  ${t.active?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}
                  ${!t.url&&"opacity-50 cursor-not-allowed"}
                `,dangerouslySetInnerHTML:{__html:t.label}},r))})]}),e.jsx(X,{open:me,onOpenChange:D,children:e.jsxs(Z,{className:"max-w-lg rounded-xl border border-gray-200 shadow-md bg-white",children:[e.jsxs(ee,{className:"pb-3 border-b border-gray-100",children:[e.jsx(te,{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:"Return Items"}),e.jsx(se,{className:"text-sm text-gray-500",children:"Select items to return and specify whether they are for reissuance or disposal."})]}),N?(()=>{const t=N.items||[],r=t.every(a=>a.reissuedItem||a.disposedItem||a.status==="reissued"||a.status==="disposed");return e.jsxs("div",{className:"mt-4 space-y-2 max-h-72 overflow-y-auto p-2 border rounded-md bg-gray-50",children:[!r&&e.jsxs("div",{className:"flex items-center gap-2 mb-2 px-2 py-1 rounded-md hover:bg-gray-100",children:[e.jsx("input",{id:"select-all-return",type:"checkbox",checked:t.every(a=>v.includes(a.id))||!1,onChange:a=>{a.target.checked?R(i=>[...new Set([...i,...t.map(s=>s.id)])]):R(i=>i.filter(s=>!t.map(d=>d.id).includes(s)))},className:"h-4 w-4 accent-blue-600"}),e.jsx("label",{htmlFor:"select-all-return",className:"text-sm font-medium text-gray-700 cursor-pointer select-none",children:"Select all"})]}),(()=>{const a=N.items||[];return console.log({lowItems:a}),a.every(s=>{const d=Number(s.quantity??0),l=Number(s.total_reissued_quantity??0),c=Number(s.total_disposed_quantity??0);return l+c>=d})?e.jsxs("div",{className:"p-4 text-center text-gray-500 text-sm italic bg-gray-50 rounded-md border border-gray-200",children:["All items in this issuance have already been"," ",e.jsx("span",{className:"font-semibold text-blue-600",children:"reissued"})," or"," ",e.jsx("span",{className:"font-semibold text-rose-600",children:"disposed"}),"."]}):a.map(s=>{var w,I,q,P,k;const d=((I=(w=s.inventoryItem)==null?void 0:w.product)==null?void 0:I.name)??((q=s.inventory_item)==null?void 0:q.item_desc)??"N/A",l=((k=(P=s.inventory_item)==null?void 0:P.product)==null?void 0:k.specs)??"",c=Number(s.quantity??0),n=Number(s.total_reissued_quantity??0),o=Number(s.total_disposed_quantity??0),h=n+o,x=Math.max(c-h,0),b=x===0&&n>0,p=x===0&&o>0,j=x>0&&(n>0||o>0),y=b||p;return e.jsxs("label",{className:`flex items-start gap-3 p-3 rounded-md border transition-colors ${v.includes(s.id)?"bg-blue-50 border-blue-300":"bg-white hover:bg-gray-50 border-gray-200"} ${y?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx("input",{type:"checkbox",checked:v.includes(s.id),disabled:y,onChange:L=>{y||R(F=>L.target.checked?[...F,s.id]:F.filter(T=>T!==s.id))},className:"mt-1 h-4 w-4 accent-blue-600"}),e.jsxs("div",{className:"flex flex-col flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-gray-800",children:d}),b||p?e.jsx("span",{className:`text-xs font-semibold px-2 py-0.5 rounded-full ${p?"bg-rose-100 text-rose-700 border border-rose-300":"bg-blue-100 text-blue-700 border border-blue-300"}`,children:p?"Returned":"Reissued"}):j?e.jsxs("span",{className:"text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-50 text-yellow-700 border border-yellow-300",children:["Some Items are returned (",h,"/",c,")"]}):e.jsxs("span",{className:"text-xs text-gray-600",children:["Remaining: ",x]})]}),l&&e.jsx("div",{className:"text-gray-500 text-xs",children:l}),e.jsxs("div",{className:"text-gray-500 text-xs mt-0.5",children:["Qty: ",s.quantity," | ₱",Number(s.unit_cost??0).toFixed(2)]}),(n>0||o>0)&&e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:["Returned:"," ",e.jsxs("span",{className:"text-blue-600 font-medium",children:[n," reissued"]})," ","|"," ",e.jsxs("span",{className:"text-rose-600 font-medium",children:[o," disposed"]})]})]})]},s.id)})})()]})})():e.jsx("p",{className:"text-gray-500 text-sm mt-3 italic",children:"No items available."}),e.jsxs("div",{className:"mt-5 border-t pt-4",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"Return Type"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3",children:[e.jsxs("label",{className:`flex items-center gap-2 cursor-pointer px-3 py-2 border rounded-md transition-all ${g==="reissuance"?"border-blue-400 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("input",{type:"radio",name:"returnType",value:"reissuance",checked:g==="reissuance",onChange:t=>M(t.target.value),className:"h-4 w-4 accent-blue-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"For Reissuance"})]}),e.jsxs("label",{className:`flex items-center gap-2 cursor-pointer px-3 py-2 border rounded-md transition-all ${g==="disposal"?"border-rose-400 bg-rose-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("input",{type:"radio",name:"returnType",value:"disposal",checked:g==="disposal",onChange:t=>M(t.target.value),className:"h-4 w-4 accent-rose-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"For Disposal"})]})]})]}),e.jsxs(ae,{className:"pt-5 border-t mt-4",children:[e.jsx(_,{variant:"outline",className:"w-28",onClick:()=>{D(!1),R([]),M(""),E(null)},children:"Cancel"}),e.jsx(_,{className:`w-28 text-white ${g==="disposal"?"bg-rose-600 hover:bg-rose-700":"bg-blue-600 hover:bg-blue-700"}`,disabled:!v.length||!g||N&&(N.items||[]).every(t=>{const r=Number(t.quantity??0),a=Number(t.total_reissued_quantity??0),i=Number(t.total_disposed_quantity??0),s=a+i;return console.log({totalQty:r,reissuedQty:a,disposedQty:i,totalProcessed:s}),s>=r}),onClick:()=>{if((N.items||[]).every(i=>{var n,o;const s=Number(i.quantity??0),d=Number(((n=i.reissued_item)==null?void 0:n.quantity)??0),l=Number(((o=i.disposed_item)==null?void 0:o.quantity)??0);return d+l>=s})){toast({title:"All items already processed",description:"There are no items left to return.",variant:"destructive"});return}if(v.length===0){toast({title:"No items selected",description:"Please select at least one item to return.",variant:"destructive"});return}if(!g){toast({title:"No return type chosen",description:"Please specify whether this return is for reissuance or disposal.",variant:"destructive"});return}const a=g==="reissuance"?"supply_officer.reissuance_form":"supply_officer.disposal_form";K.visit(route(a,{id:N.id,type:"ris",items:v.join(",")})),D(!1)},children:"Proceed"})]})]})}),e.jsx(X,{open:xe,onOpenChange:O,children:e.jsxs(Z,{className:"max-w-lg rounded-xl border border-gray-200 shadow-md bg-white",children:[e.jsxs(ee,{className:"pb-3 border-b border-gray-100",children:[e.jsx(te,{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:"Switch Type"}),e.jsxs(se,{className:"text-sm text-gray-500",children:["Select items you want to switch to ",e.jsx("b",{children:"High Value"})," type."]})]}),Q?e.jsx("div",{className:"mt-4 space-y-2 max-h-72 overflow-y-auto p-2 border rounded-md bg-gray-50",children:(Q.items||[]).map(t=>{var i,s,d,l,c;const r=((s=(i=t.inventoryItem)==null?void 0:i.product)==null?void 0:s.name)??((d=t.inventory_item)==null?void 0:d.item_desc)??"N/A",a=((c=(l=t.inventoryItem)==null?void 0:l.product)==null?void 0:c.specs)??"";return e.jsxs("label",{className:`flex items-start gap-3 p-3 rounded-md border transition-colors ${$.includes(t.id)?"bg-blue-50 border-blue-300":"bg-white hover:bg-gray-50 border-gray-200"}`,children:[e.jsx("input",{type:"checkbox",checked:$.includes(t.id),onChange:n=>{Y(o=>n.target.checked?[...o,t.id]:o.filter(h=>h!==t.id))},className:"mt-1 h-4 w-4 accent-blue-600"}),e.jsxs("div",{className:"flex flex-col flex-1",children:[e.jsx("div",{className:"font-medium text-gray-800",children:r}),a&&e.jsx("div",{className:"text-gray-500 text-xs",children:a}),e.jsxs("div",{className:"text-gray-500 text-xs mt-0.5",children:["Qty: ",t.quantity," | ₱",Number(t.unit_cost??0).toFixed(2)]})]})]},t.id)})}):e.jsx("p",{className:"text-gray-500 text-sm mt-3 italic",children:"No items available."}),e.jsxs(ae,{className:"pt-5 border-t mt-4",children:[e.jsx(_,{variant:"outline",className:"w-28",onClick:()=>{O(!1),Y([]),z(null)},children:"Cancel"}),e.jsx(_,{className:"w-28 bg-blue-600 text-white hover:bg-blue-700",disabled:!$.length,onClick:()=>{var t;K.visit(route("supply_officer.switch_type",{type:"ris",id:Q.id,po_id:(t=Q.po)==null?void 0:t.id,items:$}))},children:"Continue"})]})]})})]})}export{Ve as default};
