import{r as l,u as A,j as e,H}from"./app-z2zUCIH2.js";import{S as M}from"./SupplyOfficerLayout-BfXjfZkg.js";import{D,a as P,b as O,c as I,d as q,e as F}from"./dialog-Dc_xfRUc.js";import{B as c}from"./button-BxtF8k1k.js";import{T as B}from"./triangle-alert-BCfU61J_.js";import"./toaster-De5hWt1k.js";import"./use-toast-Byxe34qQ.js";import"./index-CMYY62sn.js";import"./index-BPRSbHGy.js";import"./createLucideIcon-B5xgoSjl.js";import"./utils-Cf4Ri238.js";import"./index-ZeHC1oZz.js";import"./Dropdown-DTp9JO5b.js";import"./transition-Mdjj0t_f.js";import"./XMarkIcon--6nDV5HQ.js";import"./clipboard-check-DtUsxnJ2.js";import"./package-check-DGQj4OaT.js";import"./index-DDOX9kOw.js";function ce({pr:h,rfq:R,suppliers:_,winners:d}){const S=l.useMemo(()=>[...new Set(d.map(t=>t.supplier_id))],[d]),g=l.useMemo(()=>_.filter(t=>S.includes(t.id)),[_,S]),[w,p]=l.useState(!1),[C,b]=l.useState(null),[f,y]=l.useState(""),[T,m]=l.useState(!1),Q=t=>d.filter(i=>i.supplier_id===t).map(i=>({pr_detail_id:i.pr_detail_id,item:i.item,specs:i.specs,unit:i.unit,quantity:i.quantity,unit_price:Number(i.unit_price??0),total_price:Number(i.total_price??0),priceSource:i.unit_price_edited?"As Calculated Price":"Quoted Price",supplier_id:t,supplier_total:i.supplier_total??null})),{data:u,setData:j,post:U,processing:x}=A({rfq_id:R.id,items:[]});l.useEffect(()=>{const t=g.flatMap(a=>Q(a.id));j("items",t)},[g]);const k=(t,a,i)=>{var v;const s=[...u.items],n=s.findIndex(N=>N.pr_detail_id===t);if(n===-1)return;const r=Number(i)>=0?Number(i):0,o=(v=h.details.find(N=>N.id===s[n].pr_detail_id))==null?void 0:v.quantity;if(r!==o){b({index:n,field:a,value:r}),p(!0);return}s[n][a]=r,s[n].total_price=Number(s[n].quantity)*Number(s[n].unit_price),j("items",s)},E=()=>{if(!C)return;const{index:t,field:a,value:i}=C,s=[...u.items];s[t][a]=i,s[t].total_price=Number(s[t].quantity)*Number(s[t].unit_price),s[t].change_reason=f,j("items",s),b(null),y(""),p(!1)},L=t=>{t.preventDefault(),m(!0)},$=()=>{U(route("supply_officer.store_po"),{onFinish:()=>m(!1)})};return e.jsxs(M,{header:"Schools Divisions Office - Ilagan | Create Purchase Order",children:[e.jsx(H,{title:`Create PO for PR #${h.pr_number}`}),e.jsxs("form",{onSubmit:L,className:"bg-white p-6 rounded shadow mx-auto max-w-6xl",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-6",children:["Create PO for PR #",h.pr_number]}),g.map(t=>{var s,n;const a=u.items.filter(r=>r.supplier_id===t.id);(s=a.find(r=>r.supplier_total!==null))==null||s.supplier_total;const i=((n=d.find(r=>r.supplier_id===t.id))==null?void 0:n.supplier_total)||a.reduce((r,o)=>r+Number(o.total_price),0);return console.log({supplier:t,supplierItems:a,supplierTotal:i}),e.jsxs("div",{className:"mb-8 border rounded-lg shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-3 font-semibold text-lg",children:["Supplier: ",t.company_name]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto border-separate border-spacing-0 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-y border-l px-4 py-2 text-left",children:"Item"}),e.jsx("th",{className:"border-y px-4 py-2 text-left",children:"Specs"}),e.jsx("th",{className:"border-y px-4 py-2 text-center",children:"Unit"}),e.jsx("th",{className:"border-y px-4 py-2 text-right text-blue-600",children:"Quantity"}),e.jsx("th",{className:"border-y px-4 py-2 text-right",children:"Unit Price"}),e.jsx("th",{className:"border-y px-4 py-2 text-right",children:"Total Price"})]})}),e.jsxs("tbody",{children:[a.map(r=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border-b border-l px-4 py-2",children:r.item}),e.jsx("td",{className:"border-b px-4 py-2 text-gray-600",children:r.specs}),e.jsx("td",{className:"border-b px-4 py-2 text-center",children:r.unit}),e.jsx("td",{className:"border-b px-4 py-2 text-right",children:e.jsx("input",{type:"number",min:"0",value:r.quantity,onChange:o=>k(r.pr_detail_id,"quantity",o.target.value),className:"w-20 border rounded px-2 py-1 text-right bg-yellow-50"})}),e.jsxs("td",{className:"border-b px-4 py-2 text-right",children:["₱",Number(r.unit_price).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),e.jsx("div",{className:`text-xs ${r.priceSource==="Quoted Price"?"text-green-600":"text-gray-500"}`,children:r.priceSource})]}),e.jsxs("td",{className:"border-b px-4 py-2 text-right",children:["₱",(r.unit_price*r.quantity).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},`${t.id}-${r.pr_detail_id}`)),e.jsxs("tr",{className:"bg-gray-100 font-semibold",children:[e.jsx("td",{colSpan:"5",className:"border-t px-4 py-2 text-right",children:"Supplier Total:"}),e.jsxs("td",{className:"border-t border-r px-4 py-2 text-right",children:["₱",i.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]})})]},t.id)}),e.jsx(c,{type:"submit",disabled:x||u.items.length===0,className:"mt-6",children:x?"Submitting...":"Submit Purchase Order"})]}),e.jsx(D,{open:T,onOpenChange:m,children:e.jsxs(P,{children:[e.jsxs(O,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"text-yellow-500"}),"Confirm Submission"]}),e.jsx(q,{className:"pt-4 text-base",children:"Are you sure you want to create this Purchase Order? Please review the items and quantities before proceeding."})]}),e.jsxs(F,{children:[e.jsx(c,{variant:"outline",onClick:()=>m(!1),children:"Cancel"}),e.jsx(c,{onClick:$,disabled:x,className:"bg-green-600 hover:bg-green-700",children:x?"Submitting...":"Confirm & Create PO"})]})]})}),e.jsx(D,{open:w,onOpenChange:p,children:e.jsxs(P,{children:[e.jsxs(O,{children:[e.jsx(I,{children:"Reason for Quantity Change"}),e.jsx(q,{className:"pt-2",children:"You changed the quantity from the original PR. Please provide a reason for this adjustment."})]}),e.jsx("textarea",{value:f,onChange:t=>y(t.target.value),className:"w-full border rounded px-3 py-2 mt-3",rows:"3",placeholder:"Enter reason..."}),e.jsxs(F,{children:[e.jsx(c,{variant:"outline",onClick:()=>{p(!1),b(null),y("")},children:"Cancel"}),e.jsx(c,{onClick:E,disabled:!f.trim(),className:"bg-blue-600 hover:bg-blue-700",children:"Save Change"})]})]})})]})}export{ce as default};
